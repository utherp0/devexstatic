<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Red Hat DSA UKI &lt;uther@redhat.com&gt;">
<title>OpenShift 4.3 DevEx Advanced Workshop</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>OpenShift 4.3 DevEx Advanced Workshop</h1>
<div class="details">
<span id="author" class="author">Red Hat DSA UKI</span><br>
<span id="email" class="email"><a href="mailto:uther@redhat.com">uther@redhat.com</a></span><br>
<span id="revnumber">version 1.0.0,</span>
<span id="revdate">May 05, 2020</span>
<br><span id="revremark">Draft</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#intro">Introduction</a>
<ul class="sectlevel2">
<li><a href="#attendee-details">Attendee details</a>
<ul class="sectlevel3">
<li><a href="#what-is-openshift">What is Openshift</a></li>
<li><a href="#links">Links</a></li>
<li><a href="#contributors">Contributors</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#workshop-pre-requisites">Workshop Pre-requisites</a>
<ul class="sectlevel2">
<li><a href="#setting-up-the-ui-and-terminal">Setting up the UI and Terminal</a></li>
</ul>
</li>
<li><a href="#openshift-do">OpenShift DO</a>
<ul class="sectlevel2">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#installing">Installing</a></li>
<li><a href="#odo-command-set">odo command set</a></li>
<li><a href="#logging-in">Logging in</a>
<ul class="sectlevel3">
<li><a href="#examining-source-assets">Examining source assets</a></li>
</ul>
</li>
<li><a href="#create-push-source-run-cycle">Create, push source &amp; run cycle</a></li>
<li><a href="#odo-watch">odo watch</a></li>
</ul>
</li>
<li><a href="#camel-k-on-openshift">Camel K on Openshift</a>
<ul class="sectlevel2">
<li><a href="#introduction-2">Introduction</a></li>
<li><a href="#check-the-project-is-ready-to-use">Check the project is ready to use</a></li>
<li><a href="#camel-k-and-the-operator-lifecycle-manager">Camel K and the Operator Lifecycle Manager</a></li>
<li><a href="#deploy-a-camel-k-integration">Deploy a Camel K Integration</a></li>
<li><a href="#deploy-camel-k-in-developer-mode">Deploy Camel K in Developer mode</a></li>
</ul>
</li>
<li><a href="#openshift-pipelines-tekton">OpenShift Pipelines - Tekton</a>
<ul class="sectlevel2">
<li><a href="#introduction-3">Introduction</a></li>
<li><a href="#tasks">Tasks</a>
<ul class="sectlevel3">
<li><a href="#download-pipeline-assets">Download pipeline assets</a></li>
<li><a href="#simple-task-creation-and-execution">Simple task creation and execution</a></li>
</ul>
</li>
<li><a href="#pipelines">Pipelines</a></li>
<li><a href="#viewing-pipelines-through-the-web-ui">Viewing pipelines through the Web UI</a></li>
<li><a href="#task-inputs">Task inputs</a>
<ul class="sectlevel3">
<li><a href="#task-input-example">Task input example</a></li>
</ul>
</li>
<li><a href="#workspaces-and-volumes">Workspaces and Volumes</a></li>
</ul>
</li>
<li><a href="#camel-k-and-openshift-serverless-eventing">Camel K and OpenShift Serverless Eventing</a>
<ul class="sectlevel2">
<li><a href="#introduction-4">Introduction</a></li>
<li><a href="#check-the-project-is-ready-to-use-2">Check the project is ready to use</a></li>
<li><a href="#openshift-serverless-and-the-operator-lifecycle-manager">OpenShift Serverless and the Operator Lifecycle Manager</a></li>
<li><a href="#creating-the-pre-requisites-for-the-chapter">Creating the pre-requisites for the chapter</a></li>
<li><a href="#create-knative-messaging-channel">Create Knative Messaging Channel</a></li>
<li><a href="#deploy-the-integrations">Deploy the Integrations</a></li>
<li><a href="#edit-the-integration-to-use-a-counter-and-cache">Edit the Integration to use a Counter and Cache</a></li>
<li><a href="#knative-in-action">Knative in action</a></li>
<li><a href="#replace-knative-in-memory-messaging-with-amq-streams-kafka">Replace Knative in-memory messaging with AMQ Streams (Kafka)</a>
<ul class="sectlevel3">
<li><a href="#install-a-kafka-broker-using-amq-streams">Install a Kafka Broker using AMQ Streams</a></li>
<li><a href="#run-the-examples">Run the examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#camel-k-and-openshift-serverless-serving">Camel K and OpenShift Serverless Serving</a>
<ul class="sectlevel2">
<li><a href="#introduction-5">Introduction</a></li>
<li><a href="#check-the-project-is-ready-to-use-3">Check the project is ready to use</a></li>
<li><a href="#openshift-serverless-and-the-operator-lifecycle-manager-2">OpenShift Serverless and the Operator Lifecycle Manager</a></li>
<li><a href="#creating-the-pre-requisites-for-the-chapter-2">Creating the pre-requisites for the chapter</a></li>
<li><a href="#deploy-a-restful-integration-using-camel-k-and-an-openapi-definition">Deploy a Restful Integration using Camel K and an OpenAPI definition</a></li>
<li><a href="#knative-in-action-2">Knative in action</a></li>
</ul>
</li>
<li><a href="#openshift-and-the-quay-image-repository">OpenShift and the Quay Image Repository</a>
<ul class="sectlevel2">
<li><a href="#introduction-6">Introduction</a></li>
<li><a href="#using-the-quay-workshop-cluster">Using the Quay workshop cluster</a></li>
<li><a href="#creating-the-openshift-project">Creating the OpenShift Project</a></li>
<li><a href="#creating-the-quay-image-repositories">Creating the Quay image repositories</a></li>
<li><a href="#managing-the-quay-organization-and-repositories">Managing the Quay organization and repositories</a>
<ul class="sectlevel3">
<li><a href="#granting-permissions-to-repositories">Granting permissions to repositories</a></li>
<li><a href="#creating-a-robot-account">Creating a robot account</a></li>
<li><a href="#summary-of-quay-ui-work">Summary of Quay UI work</a></li>
</ul>
</li>
<li><a href="#pulling-openshift-images-and-pushing-to-quay">Pulling OpenShift images and pushing to Quay</a>
<ul class="sectlevel3">
<li><a href="#login-to-the-openshift-registry-using-buildah">Login to the OpenShift registry using Buildah</a></li>
<li><a href="#login-to-quay-using-buildah">Login to Quay using Buildah</a></li>
<li><a href="#examine-the-local-buildah-repository">Examine the local buildah repository</a></li>
<li><a href="#tagging-images-for-the-quay-repository">Tagging images for the Quay repository</a></li>
<li><a href="#push-the-images-to-quay">Push the images to Quay</a></li>
</ul>
</li>
<li><a href="#using-the-images-in-a-qa-environment">Using the images in a QA environment</a>
<ul class="sectlevel3">
<li><a href="#creating-the-openshift-project-for-qa">Creating the OpenShift Project for QA</a></li>
</ul>
</li>
<li><a href="#cleaning-up">Cleaning up</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="intro"><a class="anchor" href="#intro"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This advanced workshop is designed to introduce the attendee to the additional and exciting developers features above and beyond the basic functionality offered by OpenShift.</p>
</div>
<div class="paragraph">
<p>This includes an introduction to the ODO command line for developers, an introduction to Tekton, the native Kubernetes pipeline functionality, an introduction to the concepts and implementation of serverless functionality via Knative, Camel-K and eventing.</p>
</div>
<div class="sect2">
<h3 id="attendee-details"><a class="anchor" href="#attendee-details"></a>Attendee details</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-bottom"><div class="content"><div class="paragraph">
<p>Name:</p>
</div></div></td>
<td class="tableblock halign-left valign-bottom"><div class="content"></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-bottom"><div class="content"><div class="paragraph">
<p>User ID (userX):</p>
</div></div></td>
<td class="tableblock halign-left valign-bottom"><div class="content"></div></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="what-is-openshift"><a class="anchor" href="#what-is-openshift"></a>What is Openshift</h4>
<div class="paragraph">
<p>Red Hat® OpenShift® is a hybrid cloud, enterprise, secure Kubernetes application platform.</p>
</div>
<div class="paragraph">
<p>OpenShift is an Enterprise strength, secure implementation of the Kubernetes container orchestration project with additional tooling designed to make the lives of Developer and Administrators as easy as possible.</p>
</div>
</div>
<div class="sect3">
<h4 id="links"><a class="anchor" href="#links"></a>Links</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.openshift.com/learn/what-is-openshift">https://www.openshift.com/learn/what-is-openshift</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/OpenShift">https://en.wikipedia.org/wiki/OpenShift</a></p>
</li>
<li>
<p><a href="https://www.openshift.com/products/container-platform">https://www.openshift.com/products/container-platform</a></p>
</li>
<li>
<p><a href="https://console-openshift-console.apps.cluster-devex1-4789.devex1-4789.example.opentlc.com/" class="bare">https://console-openshift-console.apps.cluster-devex1-4789.devex1-4789.example.opentlc.com/</a> (the Web Console URL for the Workshop)</p>
</li>
<li>
<p> (The Web Terminal URL for the workshop)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="contributors"><a class="anchor" href="#contributors"></a>Contributors</h4>
<div class="paragraph">
<p>Red Hat UK DSA Team:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Phil Prosser</p>
</li>
<li>
<p>Mark Roberts</p>
</li>
<li>
<p>''Uther'' Lawson</p>
</li>
<li>
<p>Jonny Browning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Original asciidoc documentation for DevEx3.x by Phillip Kruger, Red Hat CEMEA</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="workshop-pre-requisites"><a class="anchor" href="#workshop-pre-requisites"></a>Workshop Pre-requisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="setting-up-the-ui-and-terminal"><a class="anchor" href="#setting-up-the-ui-and-terminal"></a>Setting up the UI and Terminal</h3>
<div class="paragraph">
<p><strong>The workshop was designed and tested on the Chrome browser and it is advised to avoid issues that this browser be used whenever possible</strong></p>
</div>
<div class="paragraph">
<p>Open the browser and navigate to the console url <a href="https://console-openshift-console.apps.cluster-devex1-4789.devex1-4789.example.opentlc.com/" class="bare">https://console-openshift-console.apps.cluster-devex1-4789.devex1-4789.example.opentlc.com/</a></p>
</div>
<div class="paragraph">
<p>Logon using the user provided by the course administrator (userx where x is a unique number for your session)</p>
</div>
<div class="paragraph">
<p>When logged on you will be presented with a screen listing the projects, of which there are currently none</p>
</div>
<div class="paragraph">
<p>Hit 'Create Project'</p>
</div>
<div class="paragraph">
<p>For 'Name' enter sandboxx, where x is your unique number</p>
</div>
<div class="paragraph">
<p>For the duration of the advanced workshop you will be working in this project</p>
</div>
<div class="paragraph">
<p>'Display Name' and 'Description' are optional labels</p>
</div>
<div class="paragraph">
<p>Once the project has been created (you will be given a dashboard) change the mode of the UI from Administrator to Developer by clicking on the top left of the UI where it says 'Administrator' and selecting 'Developer'</p>
</div>
<div class="paragraph">
<p>On the Topology page it will state 'No workloads found' - Click on 'Container Image'</p>
</div>
<div class="paragraph">
<p>In 'Image Name' enter 'quay.io/ilawson/devex4'</p>
</div>
<div class="paragraph">
<p>Click on the search icon to the right of the text box</p>
</div>
<div class="paragraph">
<p>Leave everything else as default and scroll down to the bottom of the page. Hit 'Create'</p>
</div>
<div class="paragraph">
<p>Wait for the ring around the application icon to change to dark blue - this indicates the application has been started</p>
</div>
<div class="paragraph">
<p>In the topology page click on the 'Show URL' icon as shown below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/prereq-1.png" alt="Selecting the Show URL">
</div>
</div>
<div class="paragraph">
<p>This will open another tab with a command line in it - this is your terminal for the duration of the advanced workshop</p>
</div>
<div class="paragraph">
<p>Switch back to the UI and click on the userx displayed at the top right and select 'Copy Login Command' as shown below</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/prereq-2.png" alt="Selecting Copy Login"></span></p>
</div>
<div class="paragraph">
<p>In the new tab that appears login with your userx (unique number instead of x) and password 'openshift'</p>
</div>
<div class="paragraph">
<p>Click on 'Display Token'</p>
</div>
<div class="paragraph">
<p>Copy the command given for 'Log in with this token' - this may require using the browser 'copy' command after highlighting the command</p>
</div>
<div class="paragraph">
<p>Close this tab and switch to the terminal tab - if you have closed the terminal tab go back to the UI and select the 'Show URL' from the topology view in the Developer UI</p>
</div>
<div class="paragraph">
<p>Paste and execute the command</p>
</div>
<div class="paragraph">
<p>Press 'y' to use insecure connections</p>
</div>
<div class="paragraph">
<p>The terminal should now be logged on - to check it try</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc version</code></pre>
</div>
</div>
<div class="paragraph">
<p>The terminal should display your user for the first command and the client and Kubernetes versions for the second command</p>
</div>
<div class="paragraph">
<p>Finally, for use in the examples we will require some source material from the git repo for this workshop. To set this up type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace
git clone https://github.com/utherp0/workshop4
ls -alR</code></pre>
</div>
</div>
<div class="paragraph">
<p>These files are the source of the Workshop and all the required local material for the course.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift-do"><a class="anchor" href="#openshift-do"></a>OpenShift DO</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">An overview of odo</div>
<div class="paragraph">
<p>The OpenShift command line interface 'oc' is a general purpose interface with a vast set of commands for both development and administrative purposes. The odo command is a more developer centric command line interface for users who simply want to build, deploy and run applications on OpenShift. There is definitely a place for both tools within the kitbag of an OpenShift user, and for fast iterations of edit - run - edit - run the odo interface is perfect.</p>
</div>
<div class="paragraph">
<p>The approach described in the application basics chapter used a GIT repository as the source of the content to be built and deployed. This is a excellent approach when multiple users are working together in a complex application performing frequent integration of source code in GIT and validating their combined efforts as the project progresses. Avoiding such frequent integration activity will make the code of each developer diverge storing up integration headaches in the future.</p>
</div>
<div class="paragraph">
<p>The ability of the OpenShift 'Source-2-image' capability to identify the code within the GIT repository (from the options of Node.js, Java, Ruby, Perl, PHP, and Python), select a builder image, build the code and deliver a new container with the running application is a huge efficiency advantage for teams. However there are scenarios in which a single developer simply wants to get their code running as quickly as possible and which is where odo can be advantageous.</p>
</div>
<div class="paragraph">
<p>The principle of the odo command is that it can very quickly create a new project and use a 'GIT like' syntax to enable a developer to push the code into OpenShift. The receiving OpenShift cluster will then decide how to build the code, perform the build and deliver a running container. When the developer wants to make changes they simply push their code and the build and deploy operations are repeated. The first push process may take around a minute, but after that each iteration will take only a few seconds.</p>
</div>
<div class="paragraph">
<p>The diagram below shows how the odo command can fit into a development cycle. The outline diagram shows that the odo command is appropriate for single developers working with a degree of isolation, the team development involves multiple developers integrating their code through a GIT repository and the final phase involves the use of multiple clusters for the deployment of applications through to production.</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/odo-1.png" alt="odo in the development cycle">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>In more detail the diagram below shows how odo and oc / source-2-image work together to create a scaled development experience. In the single user phase the odo command is used to push the application code to a container in OpenShift. In the light blue box the source code is pushed to OpenShift in which the language specific builder image is used to create a new image containing the built code. This  image is started to create a running container. When the developer needs to share the code with the work of others GIT is used as a vehicle for integration and to remove any code conflicts.  This is the medium blue box in which the code is pushed to GIT and the OpenShift source-2-image capability is used to build a new running container. In the final phase shown in the darker blue box, the built container image can then be pushed to the Quay image repository to be stored securely ready for deployment to further environments such as pre-production and production.</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/odo-2.png" alt="odo in the development cycle - detail">
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing"><a class="anchor" href="#installing"></a>Installing</h3>
<div class="paragraph">
<p>The odo command line interface is built into the terminal that you create as a pre-requisite for this workshop so you don&#8217;t have to install anything right now. However, if you want to install the interface on your own workstation then it is available for download from here : <a href="https://github.com/openshift/odo" class="bare">https://github.com/openshift/odo</a>.</p>
</div>
<div class="paragraph">
<p><strong>If you haven&#8217;t already please follow the instructions in the pre-req chapter which explains the creation and setting up of the terminal application. For this chapter you will be using that application which has the odo command pre-installed for you</strong></p>
</div>
<div class="paragraph">
<p>Switch to the terminal application tab of the browser as dsecribed in the pre-req chapter</p>
</div>
<div class="paragraph">
<p><strong>To use the command simply type 'odo' and you will see help regarding the objects and to get help on a specific object use 'odo &lt;object&gt; --help'.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="odo-command-set"><a class="anchor" href="#odo-command-set"></a>odo command set</h3>
<div class="paragraph">
<p><strong>The odo command has the following subcommands :</strong></p>
</div>
<div class="paragraph">
<p>Commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>app         Perform application operations (delete, describe, list)
catalog     Catalog related operations (describe, list, search)
component   Manage components (create, delete, describe, link, list, log, push, unlink, update, watch)
config      Change or view configuration (set, unset, view)
debug       Debug commands (port-forward)
preference  Modifies preference settings (set, unset, view)
project     Perform project operations (create, delete, get, list, set)
service     Perform service catalog operations (create, delete, list)
storage     Perform storage operations (create, delete, list)
url         Expose component to the outside world (create, delete, list)</pre>
</div>
</div>
<div class="paragraph">
<p>Utility Commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>login       Login to cluster
logout      Log out of the current OpenShift session
utils       Utilities for terminal commands and modifying odo configurations (terminal)
version     Print the client version information</pre>
</div>
</div>
<div class="paragraph">
<p>Component Shortcuts:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>create      Create a new component
delete      Delete component
describe    Describe component
link        Link component to a service or component
list        List all components in the current application
log         Retrieve the log for the given component
push        Push source code to a component
unlink      Unlink component to a service or component
update      Update the source code path of a component
watch       Watch for changes, update component on change</pre>
</div>
</div>
<div class="paragraph">
<p><strong>The most common are used within this workshop but feel free to experiment with any of the above commands.</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="logging-in"><a class="anchor" href="#logging-in"></a>Logging in</h3>
<div class="paragraph">
<p><strong>At this point if you are using the terminal as explained in the pre-req chapter you will already be logged into the system. This can be checked by typing the following:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
odo project list</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should result in your user name being displayed followed by the sandboxX project being shown by the result to the odo command</p>
</div>
<div class="paragraph">
<p><strong>If you do need to login to odo outside of this workshop use the 'odo login' command with appropriate parameters</strong></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The odo command will evolve over time and it performs a check to see if you have the latest version each time it is used. If there is an update available you will be given a prompt to update from a given URL
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see which version of odo you are using enter the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo version</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="examining-source-assets"><a class="anchor" href="#examining-source-assets"></a>Examining source assets</h4>
<div class="paragraph">
<p>The pipeline assets are located in a GIT repository that has been preinstalled in the terminal. Using your terminal window check the assets using the commands below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/slave

ls -al</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see that the directory only has the source file slave.js and the package file called package.json.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-push-source-run-cycle"><a class="anchor" href="#create-push-source-run-cycle"></a>Create, push source &amp; run cycle</h3>
<div class="paragraph">
<p>Create a new project using the odo command replacing X with your user number below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo create nodejs node-app-slave</code></pre>
</div>
</div>
<div class="paragraph">
<p>TIP:The syntax of the above command is 'odo create &lt;component-type&gt; &lt;component-name&gt; --project &lt;project-for-the-component&gt;'</p>
</div>
<div class="paragraph">
<p>The result of running this command is simply the creation of a .odo directory containing a config.yaml file. The file contains the desired state for the application in OpenShift and is only committed to OpenShift and acted upon by OpenShift when the user issues the command 'odo push'. Examine the config.yaml file with the command below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>---
cat .odo/config.yaml
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a route for the application by using the command below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo url create node-app-slave</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the contents of the .odo/config.yaml file again and you will see that new content has been added</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cat .odo/config.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now push the configuration to OpenShift by using the command below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo push</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the above command is shown below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/odo-3.png" alt="odo in the development cycle - detail">
</div>
</div>
<div class="paragraph">
<p>Wait for the response "Changes successfully pushed to component"</p>
</div>
<div class="paragraph">
<p>The application has started up and will be running at the URL indicated in the output above. Copy the URL from your command window and paste it into a new browser tab. You should see an output similar to that shown below.</p>
</div>
<div class="paragraph">
<p>Note - within the terminal window to copy text you should highlight the text, right click and select copy. To past to the terminal window use ctrl-shift-v.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Hello - this is the simple slave REST interface v1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now make a small change to the comment in the source code of the slave.js file to change the line shown below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>response.send('Hello - this is the simple slave REST interface' + versionIdentifier);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Change the response to the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>response.send('Hello - MODIFIED and pushed with ODO' + versionIdentifier);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now use odo to push the changed source to OpenShift</p>
</div>
<div class="paragraph">
<p>odo push</p>
</div>
<div class="paragraph">
<p>The code still needed to be pushed to the component, but the final stage of building the component is much faster. Refresh the browser window showing the application output and you will see your code change. The edit - push - test cycle is as simple as that</p>
</div>
</div>
<div class="sect2">
<h3 id="odo-watch"><a class="anchor" href="#odo-watch"></a>odo watch</h3>
<div class="paragraph">
<p>The odo process also has a 'watch' facility that allows you to force odo to constantly watch for source code changes and push them immediately. Open another instance of the terminal application by pointing a new tab in the browser to the route to the terminal application.</p>
</div>
<div class="paragraph">
<p>In the new terminal tab enter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/slave
odo watch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command window should report : 'Waiting for something to change in &lt;current-working-directory&gt;'</p>
</div>
<div class="paragraph">
<p>Switch back to your other terminal window and make another change to the source code, similar to the change above. After saving the edit switch to the terminal window in which you typed 'odo watch' and observe that a new push of the code to OpenShift has taken place</p>
</div>
<div class="paragraph">
<p>The window with the watch command running will report:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>File &lt;path-to-source&gt;/slave.js changed
Pushing files...
 ✓  Waiting for component to start [73ms]
 ✓  Syncing files to the component [11s]
 ✓  Building component [4s]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refresh the browser widow showing the application output and you will see your code change</p>
</div>
<div class="paragraph">
<p>odo is clearly a very fast way to go from code to running your application without having to install tools and frameworks on your laptop</p>
</div>
<div class="paragraph">
<p>Finally, lets clean up the project by typing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>odo delete node-app-slave</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will delete the application from the project</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-on-openshift"><a class="anchor" href="#camel-k-on-openshift"></a>Camel K on Openshift</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Phil Prosser (feedback to <a href="mailto:pprosser@redhat.com">pprosser@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-2"><a class="anchor" href="#introduction-2"></a>Introduction</h3>
<div class="paragraph">
<p>Apache Camel is based on a booked called <a href="https://www.enterpriseintegrationpatterns.com">Enterprise Integration Patterns</a> that was written by Gregor Hohpe and Bobby Woolf. The purpose of the book was to describe all of the patterns required to successfully implement enterprise integrations. Apache Camel is an implementation of the Enterprise Integration Patterns. These patterns are express in Camel Routes using a <a href="https://https://en.wikipedia.org/wiki/Domain-specific_language">Domain Specific Language</a> (DSL)</p>
</div>
<div class="paragraph">
<p>Apache Camel K is a lightweight integration framework built from Apache Camel that runs natively on Kubernetes and is specifically designed for serverless and microservice architectures.</p>
</div>
<div class="paragraph">
<p>Users of Camel K can instantly run integration code written in Camel DSL on their preferred cloud (Kubernetes or OpenShift).</p>
</div>
<div class="paragraph">
<p>The purpose of this lab is to show you how easy it is to build, deploy, and delete Camel K integations using very simple examples. It is not the goal of this lab to demonstrate the integration capabilities of Camel K.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This workshop requires you to be logged on to both the OpenShift console and the terminal as described in the pre-requisites. If you do not have both tabs logged in please follow the instructions before continuing
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="check-the-project-is-ready-to-use"><a class="anchor" href="#check-the-project-is-ready-to-use"></a>Check the project is ready to use</h3>
<div class="paragraph">
<p>In the browser based terminal window, check you are still logged on and using the correct project by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc project</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If the response from the commands indicates that you are not userX (where X is your assigned user number) and not using the project sandboxX please repeat the commands in the pre-requisites.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="camel-k-and-the-operator-lifecycle-manager"><a class="anchor" href="#camel-k-and-the-operator-lifecycle-manager"></a>Camel K and the Operator Lifecycle Manager</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Camel K and the Operator Lifecycle Manager</div>
<div class="paragraph">
<p>Camel K uses the Operator Lifecycle manager, this means that new Custom Resource Definitions (CRDs) will be added to Openshift. These CRDs will extend the Openshift data model and allow Camel K to be managed using the standard ‘oc’ command. Installing operators requires a higher cluster privilage. All the required operators for the workshop should have been pre-installed for you</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The examples required for this workshop have been pre-created as part of the terminal. In the terminal type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/examples
ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are the example files we will be using.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To allow a developer to easily interact with an Openshift cluster, Camel K has it&#8217;s own command line interface. The cli is called 'kamel' and is preinstalled in the terminal app
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before we can create an integration, we need to add a Camel K 'IntegrationPlatform'.</p>
</div>
<div class="paragraph">
<p>In the terminal window, type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/camelfiles/camelkplatform/
oc apply -f integrationplatform.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>now type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get integrationplatform</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look similar to below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME      PHASE
camel-k   Ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the "Phase" says "Ready", you can continue</p>
</div>
<div class="paragraph">
<p>You should now have all the pieces you need to start creating and deploying lightweight Camel Integrations to Openshift.</p>
</div>
<div class="paragraph">
<p>Now enter the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc project
oc whoami
oc version
cd /workspace/examples
ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see an output similar to the one shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camelk-2.png" alt="Camel K file list">
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-a-camel-k-integration"><a class="anchor" href="#deploy-a-camel-k-integration"></a>Deploy a Camel K Integration</h3>
<div class="paragraph">
<p>Firstly, let’s start by deploying a simple integration, type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run simple.groovy</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The first time you deploy an Integration, it will take a few minutes. The operator manages all dependencies required by the Integration and downloads these from the Red Hat repository on demand. Once downloaded, the operator caches dependancies therefore subsequent deployments are significantly quicker. If you want to see what&#8217;s happen, in the terminal window type 'oc get pods', you will see that there are builds running
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see what is going on go to the console UI in the Browser, make sure you are switched to 'Developer view'</p>
</div>
<div class="paragraph">
<p>Click on 'Advanced/Project Details'</p>
</div>
<div class="paragraph">
<p>If your screen is wide enough the Activity pane will appear on the right hand side. If not, scroll down to the 'Activity' pane - this shows the events and actions currently occuring within the project. It will look similar to this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camelk-2a.png" alt="Deploying Camel K activity">
</div>
</div>
<div class="paragraph">
<p>Switch back to the project Topology view by clicking on 'Topology'</p>
</div>
<div class="paragraph">
<p>Once the deployment is complete, you will see 'Simple' deployed on the topology view</p>
</div>
<div class="paragraph">
<p>Click on 'Simple' (this is your integration), and you can see what’s going on.</p>
</div>
<div class="paragraph">
<p>Once the pod has a dark blue ring around it, it is running, as per the screenshot below. The devex4 application is your terminal application and can be ignored for the duration of this chapter</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camelk-3.png" alt="Running Integration">
</div>
</div>
<div class="paragraph">
<p>If you haven&#8217;t already, click 'inside the circle' to open the overview window</p>
</div>
<div class="paragraph">
<p>Click on 'Resources'</p>
</div>
<div class="paragraph">
<p>There will be one Pod running with a name similar to simple-xxxxxxx-yyyyy (randomly generated). Next to it will be an indicator that it is running. Next to that is a clickable point labelled 'View Logs'. Click on this.</p>
</div>
<div class="paragraph">
<p>The output of the log should look as shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camelk-4.png" alt="Integration logs">
</div>
</div>
<div class="paragraph">
<p>The integration is a simple timer that triggers every 1 second and writes to the log file.</p>
</div>
<div class="paragraph">
<p>In the Terminal Browser window type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get integrations</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now see an integration called 'simple' in the list similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME     PHASE     KIT                        REPLICAS
simple   Running   kit-bpj4ns3tvn0va7c7gs9g   1</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the Terminal browser window type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc describe integration simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you scan to the top of the output you will see some code in the 'from' component that represents the integration&#8217;s behaviour</p>
</div>
<div class="paragraph">
<p>We will now make a change to the integration</p>
</div>
<div class="paragraph">
<p>In the browser terminal window</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi simple.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see the text - 'Hello Camel K from ${routeId}' in the code definition of the integration</p>
</div>
<div class="paragraph">
<p>Change the text to the following by pressing [ESC] then I to insert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>'Hello Camel K from ${routeId}. Added some more text'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To save the change now hit [ESC]:wq[RETURN]</p>
</div>
<div class="paragraph">
<p>Now, you need to deploy this integration to Openshift again to test by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run simple.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are quick enough (you need to be really quick) switch back to the OpenShift console and hit 'Topology', you’ll see the integration doing a re-deployment</p>
</div>
<div class="paragraph">
<p>Look at the log file again (as above) to make sure the change has been deployed</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camelk-4a.png" alt="New output">
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-camel-k-in-developer-mode"><a class="anchor" href="#deploy-camel-k-in-developer-mode"></a>Deploy Camel K in Developer mode</h3>
<div class="paragraph">
<p>While the process of redeploying is simple, it isn’t very developer friendly. The 'kamel' cli has a developer friendly “hot deploy” mode that makes this experience much better</p>
</div>
<div class="paragraph">
<p>First delete the integration.</p>
</div>
<div class="paragraph">
<p>There are 2 ways you can do this in the Terminal Browser window (your choice). Either use the “kamel” cli:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel delete simple</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use the Openshift cli:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete integration simple</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is the great thing about CRDs, you can use the normal Openshift cli to managed the custom data model (integrations in this case)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To deploy the integration in developer mode, type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run simple.groovy --dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will see the deployment phases logged on the screen, followed by the log outputting automatically from the integration pod, useful for a developer to see what’s going on. The output should look similar to the screenshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camelk-5.png" alt="Developer Mode">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the next exercise, you will need 2 terminal windows. Go to the OpenShift Console, which should be on the Developer view. Click on Topology if the Topology window is not currently in focus. Click on the URL icon at the top right of the 'Devex4' application as you did to originally open the terminal. This will open another Terminal for you to use.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the first terminal tab, which will be the one furthest to the right, you will notice that the terminal window is outputting the log of the active and running integration
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the <strong>new</strong> terminal now type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/examples</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make another change to the text in “simple.groovy” by following the same instructions above - make sure the text outputted is different and that you save it as described above</p>
</div>
<div class="paragraph">
<p>Once you have saved the changes, go back to the browser terminal tab outputting the log</p>
</div>
<div class="paragraph">
<p>Switch to the original output tab. The integration will shutdown and restart with the new code and new text</p>
</div>
<div class="paragraph">
<p>You should see that the changes have been automatically applied to the running integration, without the need to redeploy</p>
</div>
<div class="paragraph">
<p>Go back to the browser terminal that’s outputting the log, press ‘ctrl c’</p>
</div>
<div class="paragraph">
<p>Look at the Topology view in the Openshift console(or 'oc get integrations' in the terminal)</p>
</div>
<div class="paragraph">
<p>The integration should have been deleted and no Pods should now be running (other than the Terminal pod), just like a developer would see by pressing 'ctrl c' on a Java application running on their laptop</p>
</div>
<div class="paragraph">
<p>Close down one of the terminal window tabs so you only have one terminal and the OpenShift console</p>
</div>
<div class="paragraph">
<p>If you followed the lab, the Integration should be gone, however, lets make sure we clean up the project.</p>
</div>
<div class="paragraph">
<p>In the terminal window, type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel get</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is no Integration runninng then proceed to the next lab of your choice</p>
</div>
<div class="paragraph">
<p>If an Integration is running, then please delete it by typing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel delete simple</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift-pipelines-tekton"><a class="anchor" href="#openshift-pipelines-tekton"></a>OpenShift Pipelines - Tekton</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-3"><a class="anchor" href="#introduction-3"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>For many years teams have created automation pipelines to build, unit test, analyse and deploy applications in a variety of tool-chains. Some such tool-chains (Jenkins for one) pre-date the popularisation of containers and are now being questioned for their fit for the delivery of cloud native applications. While we are at pains not to criticise Jenkins (we are big users and fans) there is scope to look at alternative approaches for cloud native applications.*</p>
</div>
<div class="paragraph">
<p>OpenShift Pipelines are based on the Tekton open source project and they provide a Kubernetes style, resource based approach to the construction of pipelines. Tasks are defined as small units of operations (typically 10 to 15 lines of YAML) and such tasks are grouped together into taskruns or pipelines for execution.</p>
</div>
<div class="paragraph">
<p>A new command line exists for the execution of Tekton commands and a graphical user interface can be added to the cluster to provide a simple way to run tasks and to observe running or completed tasks.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The Tekton project can be found here : <a href="https://tekton.dev/" class="bare">https://tekton.dev/</a></p>
</div>
<div class="paragraph">
<p>Further documentation on the specifics of Tekton can be found on the github site here : <a href="https://github.com/tektoncd/pipeline" class="bare">https://github.com/tektoncd/pipeline</a></p>
</div>
</div>
<div class="sect2">
<h3 id="tasks"><a class="anchor" href="#tasks"></a>Tasks</h3>
<div class="sect3">
<h4 id="download-pipeline-assets"><a class="anchor" href="#download-pipeline-assets"></a>Download pipeline assets</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
As part of the pre-requisites you should have cloned the required git repo and created the base project for all the chapters - if you haven&#8217;t please go back to the pre-requisites and follow the instructions
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Check the required assets for the workshop are available in your terminal image using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/attendee/tekton/
ls -al</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now see a list of yaml files that are used during the remainder of this chapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="simple-task-creation-and-execution"><a class="anchor" href="#simple-task-creation-and-execution"></a>Simple task creation and execution</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In the simplest format a task can be executed by a taskrun object. The diagram below shows a simple taskrun calling a single task
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-1.png" alt="Simple pipeline with a task and taskrun">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Tekton command line</div>
<div class="paragraph">
<p>A new command line utility is used to manage the Tekton command line. The commands cover the various different pipeline objects such as task, taskrun, pipeline, pipelinerun,  resources, cluster tasks and conditions.</p>
</div>
<div class="paragraph">
<p>The Tekton command line interface is built into the terminal that you create as a pre-requisite for this workshop so you don&#8217;t have to install anything right now. However, if you want to install the interface on your own workstation then it is available for download from here : <a href="https://github.com/tektoncd/cli" class="bare">https://github.com/tektoncd/cli</a></p>
</div>
<div class="paragraph">
<p>To use the command simply type 'tkn' and you will see help regarding the objects and to get help on a specific object use 'tkn &lt;object&gt; --help'</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To execute the above pipeline use the following commands to create the pipeline objects. Note that when creating the taskrun objects the associated task(s) will run immediately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-1.yaml
oc create -f taskrun-1.yaml
tkn taskrun ls</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response from the last command will display a line similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME          STARTED           DURATION      STATUS
task-run-1    9 seconds ago     ---           Running(Pending)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repeat the final command a few times until you see it change to be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME          STARTED           DURATION      STATUS
task-run-1    3 minutes ago    21 seconds    Succeeded</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of running the task can then be viewed by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn taskrun logs task-run-1</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>As of Tekton 0.8.0 there is an outstanding bug involving logging that may cause extraneous log messages to appear. Please ignore these, they are fixed at the next release of Tekton</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[echo-statement-1] This is my first task in Tekton

[echo-statement-2] ------------------------------------------------------------
[echo-statement-2]   - This is a multi-line comment
[echo-statement-2]   - This is useful as a separator but each line has
[echo-statement-2]   - the title repeated next to it using different colours
[echo-statement-2]   - which helps with the identification of different tasks.
[echo-statement-2]  ------------------------------------------------------------
[echo-statement-2]</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Note that the command response above uses different colours for each block of command result titles in the [ ] brackets. This helps to differential between the response for each step.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pipelines"><a class="anchor" href="#pipelines"></a>Pipelines</h3>
<div class="paragraph">
<p>Pipelines are used to manage the execution of a series of tasks within a pipeline. The example pipeline below is used to execute the Tekton tasks : task-1, task-2 and task-3. Remember that each Tekton task can have multiple steps within it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: pipeline-1
spec:
  tasks:
  - name: task-1
    taskRef:
      name: task-1
  - name: task-2
    taskref:
      name: task-2
  - name: task-3
    taskref:
      name: task-3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before executing this pipeline create the required additional resources with the commands :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-2.yaml
oc create -f task-3.yaml
oc create -f pipeline-1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute the pipeline with the following Tekton task</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipeline start pipeline-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once run switch back to the OpenShift console. If you select the Developer view you will find there is a menu option on the right hand side labelled 'Pipelines'. Select this option and the screen should look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-7.png" alt="Example Pipelines UI">
</div>
</div>
<div class="paragraph">
<p>Once the pipeline is indicated to have finished, go back to the terminal and enter the command suggested by the response to the tkn command - it will look similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipelinerun logs pipeline-1-run-kx95g -f</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the -n parameter is optional, it states the namespace to look in for the pipelinerun and we are running in a single namespace</p>
</div>
<div class="paragraph">
<p>Enter the command as provided by the tkn command and the response should look something like this:</p>
</div>
<div class="paragraph">
<p>Again, note there is a bug with Tekton 0.8.0 that may inject extraneous log errors, please ignore these.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Pipelinerun started: pipeline-1-run-ffxsk
Showing logs...
[task-2 : what-directory] /workspace

[task-2 : describe-command] ------------------------------------------------------------
[task-2 : describe-command]   - Openshift oc command line example
[task-2 : describe-command]  ------------------------------------------------------------
[task-2 : describe-command]

[task-2 : oc-version] Client Version: unknown
[task-2 : oc-version] Kubernetes Version: v1.14.6+76aeb0c

[task-3 : echo-statement-3] echo - statement 3
[task-1 : echo-statement-1] This is my first task in Tekton


[task-3 : echo-statement-4] echo - statement 4

[task-1 : echo-statement-2] ------------------------------------------------------------
[task-1 : echo-statement-2]   - This is a multi-line comment
[task-1 : echo-statement-2]   - This is useful as a separator but each line has
[task-1 : echo-statement-2]   - the title repeated next to it using different colours
[task-1 : echo-statement-2]   - which helps with the identification of different tasks.
[task-1 : echo-statement-2]  ------------------------------------------------------------</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There may be an issue in the order of the execution above. The order of the pipeline expected is different to the order observed:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   Expected               Actual
task 1 - step 1       task 2 - step 1
task 1 - step 2       task 2 - step 2
task 2 - step 1       task 2 - step 3
task 2 - step 2       task 3 - step 1
task 2 - step 3       task 1 - step 1
task 3 - step 1       task 3 - step 2
task 3 - step 2       task 1 - step 2</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In some pipelines the order of execution may not matter but if it does the order can be managed by the addition of the 'runAfter' directive to a specific task as shown in the update to the pipeline-1 pipeline shown below:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: pipeline-1
spec:
  tasks:
  - name: task-1
    taskRef:
      name: task-1
  - name: task-2
    taskref:
      name: task-2
    runAfter:
    - task-1
  - name: task-3
    taskref:
      name: task-3
    runAfter:
    - task-2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make the above changes to the pipeline-1.yaml file by using vi:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi pipeline-1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press [ESC] then i to edit/insert, make the changes to the file, then press [ESC] and type :wq[RETURN] to save the changes</p>
</div>
<div class="paragraph">
<p>Now replace the existing pipeline using the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete pipeline pipeline-1
oc create -f pipeline-1.yaml
tkn pipeline start pipeline-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>As soon as you enter the last command switch back to the console and watch the pipeline complete, note the synchronous order of the steps.</p>
</div>
</div>
<div class="sect2">
<h3 id="viewing-pipelines-through-the-web-ui"><a class="anchor" href="#viewing-pipelines-through-the-web-ui"></a>Viewing pipelines through the Web UI</h3>
<div class="paragraph">
<p>In the OpenShift console you will see the pipeline recently created and it will show a green bar to the right indicating the previous successful execution of the pipeline, as shown below. Note that the green bar will display dark blue sections for running tasks, light blue sections for pending tasks, green for completed and red for failed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-3.png" alt="Pipeline view showing a completed pipeline run">
</div>
</div>
<div class="paragraph">
<p>From the three dot menu on the right hand side it is possible to start a run of the pipeline. Do this now and watch as the screen changes to show the details of the pipeline run as shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-4.png" alt="Pipelinerun in progress">
</div>
</div>
<div class="paragraph">
<p>Each block can be clicked on to show the details of the steps within the task. Experiment with the different screens to look at the details of the running or completed tasks.</p>
</div>
</div>
<div class="sect2">
<h3 id="task-inputs"><a class="anchor" href="#task-inputs"></a>Task inputs</h3>
<div class="paragraph">
<p>There will be scenarios where it is necessary to provide specific parameters to a pipeline process and the underlying tasks that the pipeline call.</p>
</div>
<div class="paragraph">
<p>There are two mechanisms for getting specific values into tasks :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>parameters - used to provide specific values to tasks at runtime. If a parameter is declared it must either have a default value defined within the task or it must have a value supplied from a calling taskrun or pipeline run.</p>
</li>
<li>
<p>pipeline resources - a reference to a defined resource object that can be accessed by a Tekton pipeline. If a resource is referenced by a task then the resource must exist unless it has been defined as an optional resource in the task definition.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Pipeline Resource Types</div>
<div class="paragraph">
<p>The following pipeline resource types exist :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Git Resource - The git resource identifies a git repository, that contains the source code to be built by the pipeline. The resource can point to a specific branch or commit and can extract content from a specific directory.</p>
</li>
<li>
<p>Pull Request - Can be used as an input resource to identify specific meta data about a pull request. if used as an output a pull request can be updated with changes made during the pipeline process.</p>
</li>
<li>
<p>Image - An image to be created as part of the pipeline process.</p>
</li>
<li>
<p>Cluster Resource - A different cluster to the cluster on which the pipeline is running. This can be used to deploy content to an alternative cluster as part of a deployment pipeline process.</p>
</li>
<li>
<p>Storage Resource - Blob storage that contains either an object or directory.</p>
</li>
<li>
<p>Cloud Event Resource - A cloud event that is sent to a target URI upon completion of a TaskRun.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Further details on the options for all of the above resources is included here : <a href="https://github.com/tektoncd/pipeline/blob/master/docs/resources.md" class="bare">https://github.com/tektoncd/pipeline/blob/master/docs/resources.md</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="task-input-example"><a class="anchor" href="#task-input-example"></a>Task input example</h4>
<div class="paragraph">
<p>The task defined in task-4.yaml uses both parameters and pipeline resources to get information into the task. This allows a generic task to be written with specific values supplied to it from the taskrun. The Taskrun object acts as a 'value provider' giving specific values for parameters and referencing specific pipeline resources. The following diagram shows the relationship between the three specific objects.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-5.png" alt="Task and resource relationship">
</div>
</div>
<div class="paragraph">
<p>As shown above the task has place-holders for two parameters. The first parameter has a value defined within the taskrun. The second parameter has a default value so it is not essential to provide a value for it in the taskrun. Both parameters are referenced from the steps of the task using the notation $(inputs.params.&lt;parameter-name&gt;).</p>
</div>
<div class="paragraph">
<p>The task also defines a resource object called git-repo-slave of type git. Within the taskrun an input resource object is defined with the same name (git-repo-slave) referring to a pipeline resource object called git-repo-slave-resource. A pipeline resource object is created from the yaml file git-resources.yaml which makes a reference to the actual git repository.</p>
</div>
<div class="paragraph">
<p>To create the resource object go back to the terminal app and execute the following command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f git-resources.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To view the resources in the project use the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn resources list</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response will be :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                      TYPE   DETAILS
git-repo-slave-resource   git    url: https://github.com/marrober/slave-node-app.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of pipeline resource objects for git repositories and created images (as output resources) helps teams to create generic build, test and deploy pipelines that can be reused across multiple projects where the projects simply define the custom pipeline resource objects that are specific to their project or environment.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="workspaces-and-volumes"><a class="anchor" href="#workspaces-and-volumes"></a>Workspaces and Volumes</h3>
<div class="paragraph">
<p>Workspaces allow you to organise the content used by tasks and the assets that are produced by tasks. This can be useful to add structure to the content during large complex pipelines.</p>
</div>
<div class="paragraph">
<p><strong>Workspaces</strong> are storage structures within the pod that runs the containers of the pipeline and workspaces are scoped at the task level. Separate steps within a task can see the same workspace.</p>
</div>
<div class="paragraph">
<p><strong>Volumes</strong> are similar to workspaces except for the fact that they are backed by persistent volumes. This ensures that content written to the volume is accessible by steps from multiple tasks, allowing for a greater separation of steps into different tasks. For example a generic build task could be used to create an executable, writing the deliverable to a volume. A separate testing task could then be invoked by a pipeline to perform tests against the newly created deliverable. Accessing the file via a volume will work for the two separate tasks.</p>
</div>
<div class="paragraph">
<p>Task 5 has steps for creating files in the workspace and in a volume, followed by steps to display the files in the workspace and the volume which work fine. Task 6 only has tasks for attempting to display the content of the workspace and the volume. Since the workspace in task 6 is a different workspace to that used in task 5 there is no content to display. The volume however shows the file written in the step in task 5. Tasks 5 and 6 are orchestrated by the pipeline called pipeline-5.</p>
</div>
<div class="paragraph">
<p>Create the persistent volume claim to use in this exercise with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f persistentvolumeclaim.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create tasks 5 and 6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f task-5.yaml
oc create -f task-6.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the pipeline task:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc create -f pipeline-5.yaml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The persistent volume will show that it is in a pending state after creation as no resource has attempted to consume it. After the task has been executed look again at the persistent volume and it will show that it is bound.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see the state of the pvc enter the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get pvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before executing the task the state of the pvc should be as follows</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                    STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
tekton-task-cache-pvc   Pending                                                                            gp2            4s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the pipeline has completed (you will run it after this) the pvc will indicate itself as bound - try it after the pipeline has completed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME                    STATUS        VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
tekton-task-cache-pvc   Bound         pvc-1d894a93-2646-11ea-9f45-0a9970779e5c   1Gi        RWO            gp2            2m2s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute the pipeline using the following command in the terminal</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipeline start pipeline-5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now switch to the OpenShift console. Select the Pipelines entry on the left side of the Developer panel.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-8.png" alt="Two completed pipelines">
</div>
</div>
<div class="paragraph">
<p>You can click on the pipeline-run (labelled pipeline-5-run-XXXXX) and examine the logs for each of the tasks.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pipelines-9.png" alt="Task details">
</div>
</div>
<div class="paragraph">
<p>To examine the pipeline run in the terminal window use the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>tkn pipelinerun logs pipeline-5-run-XXXXX | grep -v level</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the XXXX with the information reported on screen after the execution of the tkn pipeline start command. The grep command is used to remove the erroneous logging reports.</p>
</div>
<div class="paragraph">
<p>The output will be similar to that that is shown below. Within task 5 the first step creates a file called /workspace/message. The second step displays the file name and the content of the file within the workspace. The third step creates a file in the persistent volume and the fourth step displays the file name and the content of the file within the volume.</p>
</div>
<div class="paragraph">
<p>Within task 6 the first step displays the contents of the workspace. Note that this is empty because the workspace is unique to the task. The second step of task 6 shows the content of the persistent volume which is the same a that which was reported for step 5. This shows that workspaces can be used for sharing data between steps in the same task and volumes should be used for sharing data between steps within different tasks.</p>
</div>
<div class="paragraph">
<p>[task-5 : create-a-file-in-workspace] /workspace/message</p>
</div>
<div class="paragraph">
<p>[task-5 : view-workspace-content] message
[task-5 : view-workspace-content] This is a file in the workspace</p>
</div>
<div class="paragraph">
<p>[task-5 : create-a-file-in-volume] /var/run/message</p>
</div>
<div class="paragraph">
<p>[task-5 : view-volume-content] lost+found
[task-5 : view-volume-content] message
[task-5 : view-volume-content] secrets
[task-5 : view-volume-content] This is a file in the volume</p>
</div>
<div class="paragraph">
<p>[task-6 : view-workspace-content] view workspace content
[task-6 : view-workspace-content] total 0
[task-6 : view-workspace-content] drwxrwsrwx. 2 root 1000800000  6 May  1 14:17 .
[task-6 : view-workspace-content] drwxr-xr-x. 1 root root       37 May  1 14:17 ..</p>
</div>
<div class="paragraph">
<p>[task-6 : view-volume-content] lost+found
[task-6 : view-volume-content] message
[task-6 : view-volume-content] secrets
[task-6 : view-volume-content] This is a file in the volume</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-and-openshift-serverless-eventing"><a class="anchor" href="#camel-k-and-openshift-serverless-eventing"></a>Camel K and OpenShift Serverless Eventing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Phil Prosser (feedback to <a href="mailto:pprosser@redhat.com">pprosser@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-4"><a class="anchor" href="#introduction-4"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">OpenShift Serverless</div>
<div class="paragraph">
<p>OpenShift Serverless, based on Knative is the serverless technology that was introduced in OpenShift 4.2. OpenShift Serverless enables Pods running on OpenShift to be scaled to 0 therefore taking zero processing power. Only when called, OpenShift Serverless will scale the Pod up on demand before processing the request. OpenShift Serverless also has the ability to autoscale based on load before eventually scaling back to zero when no requests are being received.</p>
</div>
<div class="paragraph">
<p>OpenShift Serverless supports "Serving" and "Eventing"</p>
</div>
<div class="paragraph">
<p>At the time of writing, Serving is in Technology Preview, and Eventing is in Developer Preview</p>
</div>
<div class="paragraph">
<p>"Serving" enables request/response workloads, and Eventing enables asynchronous event based workloads using cloudevents.</p>
</div>
<div class="paragraph">
<p>Eventing has become an important part of a Microservice architecture. It enables services to notify other services of change (typically, change in state) in a loosely coupled manner. To enable this, Knative Eventing uses a publish and subscribe architecture. This enables the source service to publish events without having the knowledge of who maybe wanting to consume the events. It allows any number of sink services to subscribe to the event and act upon it.</p>
</div>
<div class="paragraph">
<p>In this lab, we are going to look at eventing, and how easy it is to integration with Camel K.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="check-the-project-is-ready-to-use-2"><a class="anchor" href="#check-the-project-is-ready-to-use-2"></a>Check the project is ready to use</h3>
<div class="paragraph">
<p>In the browser based terminal window, check you are still logged on and using the correct project by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc project</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If the response from the commands indicates that you are not userX (where X is your assigned user number) and not using the project sandboxX please repeat the commands in the pre-requisites.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Whilst OpenShift Serverless has it&#8217;s own cli (kn), the purpose of this lab is to show the integration of Camel K into OpenShift Serverless and how easy this is to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="openshift-serverless-and-the-operator-lifecycle-manager"><a class="anchor" href="#openshift-serverless-and-the-operator-lifecycle-manager"></a>OpenShift Serverless and the Operator Lifecycle Manager</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">OpenShift Serverless and the Operator Lifecycle Manager</div>
<div class="paragraph">
<p>OpenShift Serverless uses the Operator Lifecycle manager, this means that its operator and Custom Resource Definitions (CRDs) will be added to OpenShift via "OLM". Once created, the new CRDs will extend the OpenShift data model allowing OpenShift Serverless to be managed using the standard ‘oc’ command. Installing operators requires a higher cluster privilege so the presenter will have already set these up for you.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-the-pre-requisites-for-the-chapter"><a class="anchor" href="#creating-the-pre-requisites-for-the-chapter"></a>Creating the pre-requisites for the chapter</h3>
<div class="paragraph">
<p>Before we can create an integration, we need to check that the camel-k integration added in a previous chapter is still active</p>
</div>
<div class="paragraph">
<p>In the terminal window, type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/camelfiles/camelkplatform
oc apply -f integrationplatform.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will either create the integration platform or, if it is still active, indicate it is unchanged</p>
</div>
<div class="paragraph">
<p>now type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get integrationplatform</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look similar to below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME      PHASE
camel-k   Ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the "Phase" says "Ready", you can continue</p>
</div>
</div>
<div class="sect2">
<h3 id="create-knative-messaging-channel"><a class="anchor" href="#create-knative-messaging-channel"></a>Create Knative Messaging Channel</h3>
<div class="paragraph">
<p>OpenShift Serverless uses Knative eventing. Knative eventing is a loosely coupled asynchronous architecture allowing event producers to send an event to one or more event consumers. Event Consumers can be scaled to zero when no events are following through the system.</p>
</div>
<div class="paragraph">
<p>By default, Knative uses an in-memory messaging channel. In this lab we will configure two of these channels to use with Camel K</p>
</div>
<div class="paragraph">
<p>Options are also available to replace in-memory messaging with other event sources such as the Kafka Channel. By combining Camel K and Red Hat AMQ Streams (Red Hat&#8217;s Kafka Implementation) on OpenShift you create a powerful and reliable cloud native eventing platform for your applications.</p>
</div>
<div class="paragraph">
<p>In the browser terminal window type the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/examples/knative
oc apply -f messages-channel.yaml
oc apply -f words-channel.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make sure the channels have been created correctly type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get inmemorychannel</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a screenshot like the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-4.png" alt="InMemory Channels Ready">
</div>
</div>
<div class="paragraph">
<p>You are looking for 'READY' to be 'True'</p>
</div>
</div>
<div class="sect2">
<h3 id="deploy-the-integrations"><a class="anchor" href="#deploy-the-integrations"></a>Deploy the Integrations</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Introduction to the integrations that we will use</div>
<div class="paragraph">
<p>Now that we have deployed 2 message channels, we will deploy 3 Camel K Integrations. 'feed.groovy' will generate a simple sentence every 3 seconds, and send this to the 'message channel', 'splitter.groovy' will subscribe to the 'message channel', take the message, split the message into individual words before sending the individual words to 'words channel'. Finally, 'printer.groovy' will subscribe to the 'words.channel', read the words from the channel and print them to the output log.</p>
</div>
<div class="paragraph">
<p>The flow looks like:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/knative-eventing.png" alt="knative eventing">
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>In the terminal window, deploy the 3 integrations</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run feed.groovy
kamel run splitter.groovy
kamel run printer.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>First go to the Administrator view in the OpenShift console - at the top left make sure the view is set to Administrator</p>
</div>
<div class="paragraph">
<p>Go to Workloads/Pods. As you are using a single namespace for the workshop this should display the active Pods in sandboxX, where X is your user number</p>
</div>
<div class="paragraph">
<p>Watch as the integrations are created using builder and deployment containers. This may take a little while.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-11.png" alt="Containers building">
</div>
</div>
<div class="paragraph">
<p>Once it has finished deploying the integrations you will have three Pods active as shown similar to the screenshot below (ignore the devex Pod, this is your terminal Pod)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-12.png" alt="Containers Complete">
</div>
</div>
<div class="paragraph">
<p>Now go to the developer view in the OpenShift Console</p>
</div>
<div class="paragraph">
<p>Now that all 3 of the Integrations are deployed, the topology view should look like the screenshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-5.png" alt="Integrations running">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Knative service is represented by the square box. You should see 2 of these in the topology view. On the OpenShift red logo in the middle of the service you will see the Knative "K" logo. You definitely know that you have a Knative service now. You will also notice an artefact called "KSVC", this is the Knative Service defined to OpenShift. There is also an artefact called "REV", this is the Knative revision that is current running. Revisions can be used to implement a Canary Release strategy. The diagram shows that 100% of the traffic is routed to the revision shown on the topology view. If you click on one of the "KSVC" on the topology view you will see an option to set the traffic distribution
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Each of the integrations is producing log information.</p>
</div>
<div class="paragraph">
<p>At the time of writing, there is no easy way to view the pod log files of a knative service in the console, so in the developer view click on Advanced/Project Details and choose Workloads</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-6.png" alt="Viewing overview of running Integration">
</div>
</div>
<div class="paragraph">
<p>For each workload, you should see a '1 of 1 pods' on the right hand side. 'Click' on the '1 of 1 pods'.</p>
</div>
<div class="paragraph">
<p>You should see a screen similar to the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-7.png" alt="Running Pod">
</div>
</div>
<div class="paragraph">
<p>'Click' on the Pod name on the left e.g. printer-xxxxxxxxxxxx</p>
</div>
<div class="paragraph">
<p>This should show you a screen similar to the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-8.png" alt="Pod Details">
</div>
</div>
<div class="paragraph">
<p>'Click' on 'Logs' to view the log for the pod. It should look something like the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-9.png" alt="Pod Details">
</div>
</div>
<div class="paragraph">
<p>Repeat the steps above for the other Integrations if you like.</p>
</div>
</div>
<div class="sect2">
<h3 id="edit-the-integration-to-use-a-counter-and-cache"><a class="anchor" href="#edit-the-integration-to-use-a-counter-and-cache"></a>Edit the Integration to use a Counter and Cache</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">NOTE</dt>
<dd>
<p>Because the output from the Feed Integation doesn&#8217;t change, it&#8217;s hard to see if all the messages are being processed, or indeed if some are being dropped. Lets make a small change to the Integration. The change will add a cache, and a counter to ensure that each message has a counter in it.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the terminal window edit the Integration called feed.groovy</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/examples/knative
vi feed.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Between the line starting with <strong>from</strong> and the line starting with <strong>.setBody</strong> insert the follow code (copy the code by higlightling it and copying it)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>        .setHeader("CamelCaffeineAction", constant("GET"))
        .setHeader("CamelCaffeineKey", constant("count"))
        .toF("caffeine-cache://%s", "messagecount")
        .choice()
                .when().simple('${body} == null') // When no counter stored, default to zero
                        .setHeader('counter').constant(0)
                .otherwise() // retrieve the counter
                        .setHeader('counter').simple('${body}')
        .end()
        .setHeader('counter').ognl('request.headers.counter + 1')
        .setBody().simple('${header.counter}')
        .setHeader("CamelCaffeineAction", constant("PUT"))
        .setHeader("CamelCaffeineKey", constant("count"))
        .toF("caffeine-cache://%s", "messagecount")
        .setBody().simple('Hello${header.counter} World${header.counter} from${header.counter} Camel${header.counter} K${header.counter}')</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TIP</dt>
<dd>
<p>I&#8217;m no vi expert, but if you don&#8217;t know vi, use the keyboard arrow keys to move to the line beginning with <strong>from</strong>, then to go to the end of the line press <strong>$</strong>, press <strong>i</strong>, press the <strong>right arrow</strong> once to move the cursor to the end of the line and press <strong>enter</strong> ( this shoud insert a blank line and move the cursor to the beginning of that line. Paste in the code by pressing <strong>ctrl v</strong>. Don&#8217;t worry about the indentation too much. Once pasted in press <strong>esc</strong>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The final line pasted in is <strong>.setBody</strong>. There is an existing <strong>.setBody</strong> line that we need to delete, the line looks like :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>.setBody().constant("Hello World from Camel K")</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TIP</dt>
<dd>
<p>To delete, move the cursor to the line and press <strong>dd</strong> Finally save your work by typing <strong>:wq</strong> and press <strong>enter</strong></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Once complete, the integration should look like :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// camel-k: language=groovy
/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

from('timer:clock?period=3s')
        .setHeader("CamelCaffeineAction", constant("GET"))
        .setHeader("CamelCaffeineKey", constant("count"))
        .toF("caffeine-cache://%s", "messagecount")
        .choice()
                .when().simple('${body} == null') // When no counter stored, default to zero
                        .setHeader('counter').constant(0)
                .otherwise() // retrieve the counter
                        .setHeader('counter').simple('${body}')
        .end()
        .setHeader('counter').ognl('request.headers.counter + 1')
        .setBody().simple('${header.counter}')
        .setHeader("CamelCaffeineAction", constant("PUT"))
        .setHeader("CamelCaffeineKey", constant("count"))
        .toF("caffeine-cache://%s", "messagecount")
        .setBody().simple('Hello${header.counter} World${header.counter} from${header.counter} Camel${header.counter} K${header.counter}')
        .to('knative:channel/messages')
        .log('sent message to messages channel')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each word should now have the counter appended to it</p>
</div>
<div class="paragraph">
<p>Test your work by typing :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run feed.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the skills you&#8217;ve learned to view the output of the container logs to check that the messages now contain a counter.</p>
</div>
</div>
<div class="sect2">
<h3 id="knative-in-action"><a class="anchor" href="#knative-in-action"></a>Knative in action</h3>
<div class="paragraph">
<p>Make sure you are in the developer view of the console, looking at the Topology view before continuing</p>
</div>
<div class="paragraph">
<p>The 2 Integrations "hooked" into Knative Eventing are the 'splitter' and 'printer' integrations (you can visually see this on the topology view).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see if the promise of scale to zero works.</p>
</div>
<div class="paragraph">
<p>To stop the integrations, we need to stop messages arriving at the "messages.channel". To do this, we need to stop the feed integration.</p>
</div>
<div class="paragraph">
<p>In the terminal browser window, type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel delete feed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go back to the topology view, you will notice that the feed integration has gone.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-13.png" alt="No Feed">
</div>
</div>
<div class="paragraph">
<p>Show some patience now, keep looking at the topology view, we are waiting (and hoping!) that the integrations scale down to zero.</p>
</div>
<div class="paragraph">
<p>You will know when this starts as the rings around the circles will change from the normal blue to a very dark blue, before going white. Once they are white, the integrations are scaled to zero just like the screenshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-10.png" alt="Scaled to zero">
</div>
</div>
<div class="paragraph">
<p>To wake the Integrations up again, redeploy the 'feed' integration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run feed.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go back to the topology view and you should see the 'feed' integration redeploy, and the 'splitter' and 'printer' integrations awake from their slumber.</p>
</div>
<div class="paragraph">
<p>This shows the potential for effective serverless behaviour by the down-scaling of unused applications, combined with the ease of Camel-K integrations.</p>
</div>
<div class="paragraph">
<p>To clean up before the next chapter run the following commands in the terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel delete feed
kamel delete splitter
kamel delete printer</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="replace-knative-in-memory-messaging-with-amq-streams-kafka"><a class="anchor" href="#replace-knative-in-memory-messaging-with-amq-streams-kafka"></a>Replace Knative in-memory messaging with AMQ Streams (Kafka)</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Introduction</div>
<div class="paragraph">
<p>You may have noticed that the default Knative event channel is in-memory. This means that there is the potential for message loss in the solution, and also the potential for some subscribers to miss messages.</p>
</div>
<div class="paragraph">
<p>Most applications need some form of persistent messaging, avoiding message loss in the event of something going wrong. A popular choice in the microservice world for publish and subsribe eventing is Apache Kafka. In addition to the InMemoryChannel used in the first part of this lab, Knative also has a channel type called KafkaChannel. As the name suggests, this allows Knative Eventing to use a Kafka Topic as the persistent store for the messages ensuring the reliable delivery to all subscribers.</p>
</div>
<div class="paragraph">
<p>So, we can use Kafka as a persistent store, but how do we get a Kafka Cluster installed on OpenShift?</p>
</div>
<div class="paragraph">
<p>Red Hat has an operator based Enterprise Kafka distribution called AMQ Streams. AMQ Streams is based on the open source project Strimzi (<a href="https://strimzi.io" class="bare">https://strimzi.io</a>). At the time of writing, Strimzi is a sandbox project within CNCF.</p>
</div>
<div class="paragraph">
<p>Using Kafka behind Knative eventing means that developers also get access to the full Kafka eco-system. Change Data capture could be used to publish messages that are consumed by Knative eventing clients. Kafka clients such as the streaming API could be used to read messages published by Knative based services. All Kafka API&#8217;s and services could be used as part of the solution.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Before you can continue, you need to delete the in-memory channels created earlier in the lab.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete inmemorychannel messages
oc delete inmemorychannel words</code></pre>
</div>
</div>
<div class="paragraph">
<p>Double check that the inmemorychannels have been successfully deleted</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get inmemorychannels</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>No resources found in sandboxX namespace.</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="install-a-kafka-broker-using-amq-streams"><a class="anchor" href="#install-a-kafka-broker-using-amq-streams"></a>Install a Kafka Broker using AMQ Streams</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
AMQ Streams using an Operator to perform all of the administration tasks on OpenShift. The operator is already installed for you and makes available a number of new Custom Resource Definitions (CRD). These are Kafka, KafkaBridge, KafkaConnect, KafkaConnectS2I, KafkaConnector, KafkaMirrorMaker, KafkaMirrorMaker2, KafkaTopic, and KafkaUser. As you can see, the AMQ Streams operater has a rich set of functionality. All of the configuration work can be performed throught the operator without detailed knowledge of Kafka Installations. You will see in the next step how easy it is to create an Kafka cluster, including the Kafka Brokers and Zookeeper clusters, with one simple YAML file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the operators are installed, the CRDs become available for you to use through the developer view in the OpenShift console.</p>
</div>
<div class="paragraph">
<p>In the OpenShift console, make sure you in developer view looking at your sandboxX project.</p>
</div>
<div class="paragraph">
<p>This should look similar to the screenshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-14.png" alt="Developer Console">
</div>
</div>
<div class="paragraph">
<p>Click on "+Add"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-15.png" alt="Add">
</div>
</div>
<div class="paragraph">
<p>You will see "From Catalog" on the screenshot above, 'click' on it</p>
</div>
<div class="paragraph">
<p>This will present you with the developer catalog.</p>
</div>
<div class="paragraph">
<p>Underneath the words "All Items" you will see a text box that says "Filter by keyword"</p>
</div>
<div class="paragraph">
<p>In that text box, type "kafka"</p>
</div>
<div class="paragraph">
<p>You should see a screenshot similar to the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-16.png" alt="Kafka in Catalog">
</div>
</div>
<div class="paragraph">
<p>'Click' on Kafka</p>
</div>
<div class="paragraph">
<p>'Press' the Create button</p>
</div>
<div class="paragraph">
<p>You will now be presented with a sample Kafka yaml file that looks similar to the screenshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-17.png" alt="Sample Kafka yaml">
</div>
</div>
<div class="paragraph">
<p>Due to the number of workshop attendees and the size of the OpenShift cluster we need to make the Kafka deployment smaller by reducing the number of Kafka Brokers in the cluster to 1, and the number of zookeeper instances to 1.</p>
</div>
<div class="paragraph">
<p>To do this, change</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spec.kafka.replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spec.zookeeper.replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the kafka brokers are now set to one replica, you have to modify the configuration elements below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>offset.topic.replication.factor: 1

transaction.state.log.replication.factor: 1

transaction.state.log.min.isr: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your final Kafka yaml file should look like :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: kafka.strimzi.io/v1beta1
kind: Kafka
metadata:
  name: my-cluster
  namespace: sandbox30
spec:
  kafka:
    version: 2.4.0
    replicas: 1
    listeners:
      plain: {}
      tls: {}
    config:
      offsets.topic.replication.factor: 1
      transaction.state.log.replication.factor: 1
      transaction.state.log.min.isr: 1
      log.message.format.version: '2.4'
    storage:
      type: ephemeral
  zookeeper:
    replicas: 1
    storage:
      type: ephemeral
  entityOperator:
    topicOperator: {}
    userOperator: {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press 'Create'.</p>
</div>
<div class="paragraph">
<p>You will be presented with a screen that looks similar to the screenshot below. (This is looking at the AMQ Streams operator)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-18.png" alt="AMQ Streams Operator">
</div>
</div>
<div class="paragraph">
<p>If you click on "my-cluster", you can see the current state of the Kafka deployment by scrolling to the bottom of the screen</p>
</div>
<div class="paragraph">
<p>Underneath Conditions, you are looking for</p>
</div>
<div class="paragraph">
<p>Type       Status
Ready      True</p>
</div>
<div class="paragraph">
<p>It should like the screenshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-19.png" alt="AMQ Streams Status">
</div>
</div>
<div class="paragraph">
<p>You can also go back to the Developer view in the console. You will see the Zookeeper and Kafka Brokers starting up. Once everything is started it should look similar to the screenshot below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknative-20.png" alt="AMQ Streams Topology View">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Note</dt>
<dd>
<p>To use AMQ Streams, you will use a different channel - the new channel you are going to use is called KafkaChannel. There is also a little bug at present, when you create the channels, the actual Kafka Topics will be created in the Central Broker, rather than your own. If you want to see this then please ask the instructor.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="run-the-examples"><a class="anchor" href="#run-the-examples"></a>Run the examples</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/camelfiles/streams</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before you can do work with Kafka, we need to configure the Knative Kafka dispatcher. You need to add a configmap called config-kafka to your project</p>
</div>
<div class="paragraph">
<p>edit the configmap and change the namespace to your own namespace <strong>sandboxXX</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi config-kafka.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The configmap should look similar to the one below :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: config-kafka
  namespace: sandboxXX
data:
  # Broker URL. Replace this with the URLs for your kafka cluster,
  # which is in the format of my-cluster-kafka-bootstrap.my-kafka-namespace:9092.
  bootstrapServers: my-cluster-kafka-bootstrap</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f config-kafka.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the "messages" Knative Eventing channel backed by Kafka as a persistent store. Please edit the messages.yaml file and change the namespace to your own</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi messages.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the KafkaChannel on Openshift</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f messages.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets make sure that everything appears to be wired up.</p>
</div>
<div class="paragraph">
<p>Check to make sure that the Kafka channel is deployed and ready</p>
</div>
<div class="paragraph">
<p>Type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get kafkachannel</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything worked as expected, you should see the output similar to below (This might take a couple of minutes the first time - Openshift is pulling and starting up the dispatcher)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME       READY   REASON   URL                                                     AGE
messages   True             http://messages-kn-channel.sandbox30.svc.cluster.local   47s</code></pre>
</div>
</div>
<div class="paragraph">
<p>OK, so the above output suggests that the channel is ready and working.</p>
</div>
<div class="paragraph">
<p>Lets deploy the second channel called 'words' again, this time based on a Kafka Channel</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/camelfiles/streams</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the "words" Knative Eventing channel backed by Kafka as a persistent store. Please edit the words.yaml file and change the namespace to your own</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi words.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the KafkaChannel on Openshift</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc apply -f words.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get kafkachannels</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look similar to that below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME       READY   REASON   URL                                                      AGE
messages   True             http://messages-kn-channel.sandbox30.svc.cluster.local   25m
words      True             http://words-kn-channel.sandbox30.svc.cluster.local      8s</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are now going to re-run exactly the same integrations that we used earlier in the lab, as a reminder, this is what the flow looks like</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/knative-eventing.png" alt="knative eventing">
</div>
</div>
<div class="paragraph">
<p>Make sure you are in the "Topology view" within the OpenShift console so you can see things deploy and run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/examples/knative</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the Integration that starts everything off</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run feed.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look at the log in the running pod for the feed applicaion you should see that messages it&#8217;s creating (If you cannot remember how to do this, review the instructions for the first part of this lab)</p>
</div>
<div class="paragraph">
<p>Return to the Topology view</p>
</div>
<div class="paragraph">
<p>Now run the Splitter Integration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run splitter.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now run the Printer Integration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run printer.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Take a look at the log file for the splitter Integration, you will notice something a bit weird</p>
</div>
<div class="paragraph">
<p>The splitter is outputting the message like this :-</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>2020-04-02 16:11:07.990 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:10.814 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:13.840 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:16.611 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:19.636 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:22.657 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:25.676 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel
2020-04-02 16:11:28.697 [32mINFO [m [vert.x-eventloop-thread-0] route1 - sending "SGVsbG8gV29ybGQgZnJvbSBDYW1lbCBL" to words channel</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kafka client used has serialized the messages into Base64&#8230;&#8203; not so helpful for this little example.</p>
</div>
<div class="paragraph">
<p>We can fix this by making a small change to the 'splitter.groovy' integration. This will allow the integration to transform the Base64 back to normal ascii text</p>
</div>
<div class="paragraph">
<p>Type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>vi splitter.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The integration will look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>from('knative:channel/messages')
  .split().tokenize(" ")
  .log('sending ${body} to words channel')
  .to('knative:channel/words')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before it does the ".split", add a new line and insert</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>.unmarshal().base64()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The line above with transform from Base64 to a Java byte array.
The integration should now look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>from('knative:channel/messages')
  .unmarshal().base64()
  .split().tokenize(" ")
  .log('sending ${body} to words channel')
  .to('knative:channel/words')</code></pre>
</div>
</div>
<div class="paragraph">
<p>redeploy the integration</p>
</div>
<div class="paragraph">
<p>Type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel run --dependency=camel-base64 splitter.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that the Camel Base64 dependency has been added, this enables Camel K to download the dependency and package it into the runtime</p>
</div>
<div class="paragraph">
<p>Check the pods log again, you should be able to read the text again</p>
</div>
<div class="paragraph">
<p>If you look at the printer Integration log, you will notice that it has exactly the same problem.</p>
</div>
<div class="paragraph">
<p>See if you can fix the problem for this integration by following the same steps above. The name of the file is printer.groovy</p>
</div>
<div class="paragraph">
<p>There you go, all the messaging sent using Knative eventing channels available in a Kafka topic. This means that all the events flying around the event driven network can also be made available to many other tools supported by Kafka. This could be big data systems, AI systems, mirroring events to different Kafka Clusters and many more things. Of course, the biggest benefit is that the events are now persisted, partitioned for scale, and replicated using classic Kafka functionality.</p>
</div>
<div class="paragraph">
<p>Please clean up before moving on:-</p>
</div>
<div class="paragraph">
<p>Delete Kafka channels and Kafka cluster</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete kafkachannel messages words
oc delete kafka my-cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete Camel K Integrations</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel delete feed splitter printer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete Knative Eventing Kafka dispatcher</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete deployment kafka-ch-dispatcher</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="camel-k-and-openshift-serverless-serving"><a class="anchor" href="#camel-k-and-openshift-serverless-serving"></a>Camel K and OpenShift Serverless Serving</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Phil Prosser (feedback to <a href="mailto:pprosser@redhat.com">pprosser@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-5"><a class="anchor" href="#introduction-5"></a>Introduction</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">OpenShift Serverless</div>
<div class="paragraph">
<p>OpenShift Serverless, based on Knative is the serverless technology that was introduced in OpenShift 4.2. OpenShift Serverless enables Pods running on OpenShift to be scaled to 0 therefore taking zero processing power. Only when called, OpenShift Serverless will scale the Pod up on demand before processing the request. OpenShift Serverless also has the ability to autoscale based on load before eventually scaling back to zero when no requests are being received.</p>
</div>
<div class="paragraph">
<p>OpenShift Serverless supports "Serving" and "Eventing"</p>
</div>
<div class="paragraph">
<p>At the time of writing, Eventing is in Tech Preview</p>
</div>
<div class="paragraph">
<p>"Serving" enables request/response workloads, and Eventing enables asynchronous event based workloads using cloudevents. In this lab, we are going to look at serving, and how easy it is to integrate with Camel K.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="check-the-project-is-ready-to-use-3"><a class="anchor" href="#check-the-project-is-ready-to-use-3"></a>Check the project is ready to use</h3>
<div class="paragraph">
<p>In the browser based terminal window, check you are still logged on and using the correct project by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami
oc project</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If the response from the commands indicates that you are not userX (where X is your assigned user number) and not using the project sandboxX please repeat the commands in the pre-requisites.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="openshift-serverless-and-the-operator-lifecycle-manager-2"><a class="anchor" href="#openshift-serverless-and-the-operator-lifecycle-manager-2"></a>OpenShift Serverless and the Operator Lifecycle Manager</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">OpenShift Serverless and the Operator Lifecycle Manager</div>
<div class="paragraph">
<p>OpenShift Serverless uses the Operator Lifecycle manager, this means that its operator and Custom Resource Definitions (CRDs) will be added to OpenShift via "OLM". Once created, the new CRDs will extend the OpenShift data model allowing OpenShift Serverless to be managed using the standard ‘oc’ command. Installing operators requires a higher cluster privilege so the presenter will have already set these up for you.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-the-pre-requisites-for-the-chapter-2"><a class="anchor" href="#creating-the-pre-requisites-for-the-chapter-2"></a>Creating the pre-requisites for the chapter</h3>
<div class="paragraph">
<p>Before we can create an integration, we need to check that the camel-k integration added in a previous chapter is still active</p>
</div>
<div class="paragraph">
<p>In the terminal window, type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/workshop4/camelfiles/camelkplatform
oc apply -f integrationplatform.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will either create the integration platform or, if it is still active, indicate it is unchanged</p>
</div>
<div class="paragraph">
<p>now type</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get integrationplatform</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look similar to below</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>NAME      PHASE
camel-k   Ready</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the "Phase" says "Ready", you can continue</p>
</div>
</div>
<div class="sect2">
<h3 id="deploy-a-restful-integration-using-camel-k-and-an-openapi-definition"><a class="anchor" href="#deploy-a-restful-integration-using-camel-k-and-an-openapi-definition"></a>Deploy a Restful Integration using Camel K and an OpenAPI definition</h3>
<div class="sidebarblock">
<div class="content">
<div class="title">Introduction to the integrations that we will use</div>
<div class="paragraph">
<p>This integration is a simple hello world Restful integration. The Restful API interface is defined by the OpenAPI json document called greeting-api.json. This is demonstrating top down API design with Apache Camel. An Apache Camel Route can implement this interface without the need for code. Using a "from" action called "direct" the integration enables the Camel Route to listen/respond to the operation id defined in the OpenAPI document.</p>
</div>
<div class="paragraph">
<p>Feel free to have a look at both of the files to understand whats going on.</p>
</div>
<div class="paragraph">
<p>In the terminal window, the files are located in the directory /workspace/examples</p>
</div>
<div class="paragraph">
<p>OpenAPi definition: greetings-api.json
Camel K integration: greetings.groovy</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In the terminal window, deploy the integration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd /workspace/examples
kamel run --name greetings --dependency=camel-rest --dependency camel-undertow --property camel.rest.port=8080 --open-api greetings-api.json greetings.groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go to the developer view in the OpenShift Console</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If this is the first time you&#8217;ve deployed a Camel K integration, it will take a few minutes to download the dependencies
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once, the Integration is deployed, the topology view should look like the screnshot below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-1.png" alt="Integrations running">
</div>
</div>
<div class="paragraph">
<p>Camel K has detected that OpenShift Serverless is installed and automatically deployed the integration as a Knative serving (because it&#8217;s API based) service.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TIP</dt>
<dd>
<p>The next set of instructions will only be possible if Knative Serving hasn&#8217;t already scaled the pod back to zero. If you do not see any running pods then please move on to the section title "Knative in action"</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>At the time of writing, there is no easy way to view the pod log files of a knative service in the console, so in the Developer view click on Advanced/Project Details and select Workloads. The interface should look like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-2.png" alt="Viewing overview of running Integration">
</div>
</div>
<div class="paragraph">
<p>For the greetings integration, you should see a '1 or 1 pods' on the right hand side. Click on it.</p>
</div>
<div class="paragraph">
<p>You should see a screen similar to the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-3.png" alt="Running Pod">
</div>
</div>
<div class="paragraph">
<p>Click on the row name e.g. greetings-xxxxxxxxxxxx</p>
</div>
<div class="paragraph">
<p>This should show you a screen similar to the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-4.png" alt="Pod Details">
</div>
</div>
<div class="paragraph">
<p>Click on 'Logs' to view the log for the pod. It should look something like the one below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-5.png" alt="Pod Details">
</div>
</div>
</div>
<div class="sect2">
<h3 id="knative-in-action-2"><a class="anchor" href="#knative-in-action-2"></a>Knative in action</h3>
<div class="paragraph">
<p>Following the steps above, you might find that the pod you are looking for is not there. That&#8217;s because Knative Serving has scaled the pod back to zero.</p>
</div>
<div class="paragraph">
<p>With the OpenShift console switch to developer view, viewing the toplogy. Your screen might look like the one below. If it doesn&#8217;t, wait for up to 30 seconds and it scale down to zero. By default, Knative scales down an inactive pod after 30 seconds.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-6.png" alt="Knative serving">
</div>
</div>
<div class="paragraph">
<p>Next we are going to make a call to the greetings API. To do this, you need to find out the name of http route.
To do this, in the terminal window, type in the following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get service.serving.knative.dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see something similar to the picture below</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-8.png" alt="Knative serving">
</div>
</div>
<div class="paragraph">
<p>In the terminal window type (make sure you substitute the URL you see from running the command above). Note we are adding the /camel/greetings/YOURNAMEHERE bit to the URL</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -m 60 URLFROMABOVE/camel/greetings/YOURNAMEHERE</code></pre>
</div>
</div>
<div class="paragraph">
<p>After a few seconds you should get a response, and the topology view should now look similar to the picture below. The dark blue circle indicates that the service is now executing.</p>
</div>
<div class="paragraph">
<p>At the time of writing, the inital start up time issue is known to engineering and is documented in the Red Hat documentation. A fix for this will be coming in a future release. Please remember that Knative serving is still in Tech Preview</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/camekknativeserving-7.png" alt="Knative serving started">
</div>
</div>
<div class="paragraph">
<p>Knative has automatically scaled the service to one pod, and processed the curl request.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Options are available in Knative to determine how to scale based on concurrent calls or cpu useage. Options are also available to determine maximum number or pods, and also the inactivity time before a pod scales its self down - by default, all the way back down to zero.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Deploying Integration Services with Knative can&#8217;t get easier than that!</p>
</div>
<div class="paragraph">
<p>To clean up before the next chapter run the following commands in the terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>kamel delete greetings</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openshift-and-the-quay-image-repository"><a class="anchor" href="#openshift-and-the-quay-image-repository"></a>OpenShift and the Quay Image Repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Author: Mark Roberts (feedback to <a href="mailto:mroberts@redhat.com">mroberts@redhat.com</a>)</p>
</div>
<div class="sect2">
<h3 id="introduction-6"><a class="anchor" href="#introduction-6"></a>Introduction</h3>
<div class="paragraph">
<p>During the development process a number of container images will be produced. The source-2-image capability described in the basic workshop creates images catalogued under an image stream within a project. Other container images may be created using command line functions such as docker or buildah (both using docker files potentially) or images may be downloaded from the Red Hat Container Catalogue <a href="https://catalog.redhat.com/software/containers/explore">here</a>, or other vendor supplied images may be used. From a variety of sources and through a variety of mechanisms images will be created that form the microservices of an application. Such images need to be managed through a lifecycle as they progress from Development to QA and finally to production in a process described in the diagram below. The purpose of Red Hat Quay is to provide a repository for the secure and structured storage of images that may be accessed by multiple users from multiple clusters. Quay also provides an image vulnerability scanning capability to identify issues with images stored within it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-1.png" alt="Image management process through the route to live">
</div>
</div>
<div class="paragraph">
<p>The image below shows an OpenShift project and the various artefacts that are created. The image stream object is shown here within the context of the builder process that creates it and the running pod that consumes it.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-2.png" alt="Openshift project and the creation of the image stream">
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">The structure of Quay</div>
<div class="paragraph">
<p>The Quay image repository uses a number of specific objects to manage the structure, security an maintenance of images.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Organisation - An organisation maps neatly to a project within OpenShift and is a structural container for a number of repositories.</p>
</li>
<li>
<p>Repository - A repository maps neatly to an image stream within OpenShift (or any other single source of images). A repository may contain multiple tagged versions of a single image.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The organisation may have the following characteristics:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Default permissions to be applied to any new repositories created within the organisation.</p>
</li>
<li>
<p>Teams that control access to the organisation and its repositories.</p>
</li>
<li>
<p>Robot accounts for automated access to the repositories from scripted or command line processes.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="olist arabic">
<div class="title">The objectives of this chapter are:</div>
<ol class="arabic">
<li>
<p>To understand the Quay user interface and the objects created within Quay</p>
</li>
<li>
<p>To create a process for pushing images from the OpenShift image repository to the Quay repository</p>
</li>
<li>
<p>To pull images from Quay to a new project in OpenShift to simulate the use of the images in a QA cluster</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-the-quay-workshop-cluster"><a class="anchor" href="#using-the-quay-workshop-cluster"></a>Using the Quay workshop cluster</h3>
<div class="paragraph">
<p>In order to use the Quay instance for the workshop you need to request that an id is created for you by the workshop administrators. This will take very little time and will result in the creation of the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An organisation will be created in Quay using the same name as the OpenShift project used in this section, for example master-slave-user23.</p>
</li>
<li>
<p>A Quay user matching the OpenShift username and password.</p>
</li>
<li>
<p>The Quay user will have read/write access to the organisation, but you will have to create access to the specific repositories as part of the steps to follow.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="creating-the-openshift-project"><a class="anchor" href="#creating-the-openshift-project"></a>Creating the OpenShift Project</h3>
<div class="paragraph">
<p>In order to interact with Quay each user requires an OpenShift project containing images. While the administrator is creating your Quay content use the commands below to quickly create the OpenShift project and the required content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project master-slave-userXX

oc new-app --name node-app-slave  https://github.com/marrober/slave-node-app.git

oc new-app --name node-app-master  https://github.com/marrober/master-node-app.git

oc expose service node-app-master --name="master-app-route"</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>where XX is your user number</em></p>
</div>
<div class="paragraph">
<p>The above commands will create image streams for the master and the slave which can be viewed using the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get is</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will display image streams similar to that which is shown in the table below:</p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 20%;">
<col>
<col style="width: 10%;">
<col style="width: 15%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IMAGE REPOSITORY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TAGS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UPDATED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">node-app-master</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-route-openshift-&lt;reduced&gt;.com/master-slave-userX/node-app-master</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22 hours ago</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">node-app-slave</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-route-openshift-&lt;reduced&gt;.com/master-slave-userX/node-app-slave</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22 hours ago</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The image repository field will show the route to use to get access to the container images within the container image repository. Now that you have some images to manage it is necessary to create the repositories in Quay.</p>
</div>
</div>
<div class="sect2">
<h3 id="creating-the-quay-image-repositories"><a class="anchor" href="#creating-the-quay-image-repositories"></a>Creating the Quay image repositories</h3>
<div class="paragraph">
<p>When the workshop administrator tells you that they have created your user and organisation in Quay you may login at the provided Quay URL. The username and password for Quay will be the same as those used for OpenShift.</p>
</div>
<div class="paragraph">
<p><em>The example screen shots below show a user ID of user23, but obviously yours may be different.</em></p>
</div>
<div class="paragraph">
<p>When you have logged into Quay you will see the web user interface similar to that shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-3.png" alt="Quay web user interface">
</div>
</div>
<div class="paragraph">
<p>You see two namespaces within Quay for the storage of repositories. The namespace identified by your user name can hold repositories outside the scope of an organization. The organization can hold repositories with the added benefits provided by the organization which are :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Default permissions may be set on the organization that apply to new repositories created within it.</p>
</li>
<li>
<p>The use of teams and users to manage the allocation of permissions to the organisation and the repositories created within it.</p>
</li>
</ol>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Quay permissions</div>
<div class="paragraph">
<p>The diagram below shows the permission structure for an organization.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-4.png" alt="Quay organization permissions">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Teams contain users and robot (automation) users who have permissions on specific repositories.</p>
</li>
<li>
<p>Teams can have a role of 'Creator' - Create new repositories which will inherit the organisation default permissions)or 'Admin' - perform all actions including delete, or 'member' - permission is indicated by each repository.</p>
</li>
<li>
<p>Member permissions are allocated on a per repository basis and can include 'none' - no access, 'read' - can pull images, 'write' - can pull and push images, 'admin' - can pull, push and perform admin functions such as delete and manage permissions.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="managing-the-quay-organization-and-repositories"><a class="anchor" href="#managing-the-quay-organization-and-repositories"></a>Managing the Quay organization and repositories</h3>
<div class="paragraph">
<p>Select the Quay organisation called master-slave-userXX.</p>
</div>
<div class="paragraph">
<p>This will show a largely blank screen with options down the left hand side.</p>
</div>
<div class="paragraph">
<p>Click on the '+ Create New Repository' link at the top right of the screen.</p>
</div>
<div class="paragraph">
<p>Since the names of the repositories need to match the names of the image streams in OpenShift refer back to the command line window and the names of the image streams from the 'oc get is' commands used above.</p>
</div>
<div class="paragraph">
<p>Enter the name of one of the image streams for the repository, select public for access and then click on 'Create Public Repository'.</p>
</div>
<div class="paragraph">
<p>Click the browser back button to go back to the repository creation screen and repeat the repository creation process for the second image stream.</p>
</div>
<div class="paragraph">
<p>Press the left facing arrow on the top left of the screen to go back to the list of repositories.</p>
</div>
<div class="paragraph">
<p>Select the master-slave-userXX organization and you should see the details of the organization as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-5.png" alt="Quay organization details">
</div>
</div>
<div class="sect3">
<h4 id="granting-permissions-to-repositories"><a class="anchor" href="#granting-permissions-to-repositories"></a>Granting permissions to repositories</h4>
<div class="paragraph">
<p>Select the Teams and Membership tab on the left hand side of the screen (2nd icon down). Here you can create new teams and manage the users and permissions of existing teams.</p>
</div>
<div class="paragraph">
<p>Create a new team called 'development' (only lower case letters and numbers are allowed).</p>
</div>
<div class="paragraph">
<p>You will then be prompted to add permissions for the two existing repositories. Select 'Write' permission for both repositories.</p>
</div>
<div class="paragraph">
<p>When the permissions have been added for the development team you will see the summary for teams and memberships as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-6.png" alt="Quay teams and memberships">
</div>
</div>
<div class="paragraph">
<p>At this point the development team has no members so click on the link stating '0 members' and add userXX to the team, by typing the user name into the 'add user' field on the right hand side. Press the left pointing arrow at the top left corner to return to the organization and you should see that the development team has 1 member and 2 repositories.</p>
</div>
</div>
<div class="sect3">
<h4 id="creating-a-robot-account"><a class="anchor" href="#creating-a-robot-account"></a>Creating a robot account</h4>
<div class="paragraph">
<p>Click on the next tab down from the teams and memberships tab on the left hand side of the screen to select Robot accounts. Create a new robot account called userXX_automation (where XX is you user number). You may optionally add a description if you want to.</p>
</div>
<div class="paragraph">
<p>Grant write permission to the robot account on both repositories and then click 'close'.</p>
</div>
<div class="paragraph">
<p>Click on the cog on the right hand side of the robot account name and select 'view credentials'.</p>
</div>
<div class="paragraph">
<p>You will see a list of many different types of credentials that you can generate such as token, Kubernetes secret, rkt configuration, Docker login, Docker configuration and Mesos credentials. For the access required in the workshop copy the username and token from the Robot Token tab and store them in a local editor or notepad ready to use later. Once they are copied close the dialog box.</p>
</div>
<div class="paragraph">
<p>Back on the organisation screen take a look at the options for creating default permissions (the next tab down on the left). It is possible to create default permissions to be applied to new repositories for specific uses, teams and robot users as appropriate.</p>
</div>
</div>
<div class="sect3">
<h4 id="summary-of-quay-ui-work"><a class="anchor" href="#summary-of-quay-ui-work"></a>Summary of Quay UI work</h4>
<div class="paragraph">
<p>The organization, repositories, user, robot user and permissions are all now in place within Quay for the images to be pulled from OpenShift and pushed to Quay.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pulling-openshift-images-and-pushing-to-quay"><a class="anchor" href="#pulling-openshift-images-and-pushing-to-quay"></a>Pulling OpenShift images and pushing to Quay</h3>
<div class="paragraph">
<p>Buildah will be used to pull images to a local repository, re-tag the images for the location on Quay and then push the images to Quay.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Image management tools</div>
<div class="paragraph">
<p>A number of tools exist for the management of images, three of which are described below.</p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="imageblock">
<div class="content">
<img src="images/buildah.png" alt="buildah">
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Buildah is an image building open source project that can either use Buildah specific commands to build an image or it can simply use an existing docker file. One major advantage of Buildah for some users is that it does not require a docker process to be constantly running on the workstation as root. In the workshop Buildah will be used to get images from / to OpenShift and from / to Quay.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="imageblock">
<div class="content">
<img src="images/podman.png" alt="podman">
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Podman overlaps somewhat with Buildah but its main focus is with regard to the running and interaction with container images.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-middle"><div class="content"><div class="imageblock">
<div class="content">
<img src="images/skopeo.png" alt="skopeo">
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Skopeo can be used to copy container images from one image repository to another. It can also be used to convert images between formats. It is possible to perform many of the actions in this workshop with Skopeo but by using Buildah it is possible to see what is being created in an intermediate local repository which may add some value for users.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="login-to-the-openshift-registry-using-buildah"><a class="anchor" href="#login-to-the-openshift-registry-using-buildah"></a>Login to the OpenShift registry using Buildah</h4>
<div class="paragraph">
<p>In order to pull the images it is necessary to login to the OpenShift image repository using the Buildah command even though you may already be logged into the OpenShift cluster using the oc command. The URL for the OpenShift repository is the address in the image repository table up to and including .com.</p>
</div>
<div class="paragraph">
<p>To get just the image repository URL use the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get is -o jsonpath={.items[0].status.publicDockerImageRepository} | cut -d'/' -f1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return a string similar to :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>default-route-openshift-image-registry.apps.cluster-wfh1-8946.wfh1-8946.example.opentlc.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Buildah login command takes the form :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah login --username &lt;username&gt; --password &lt;token&gt; repository-URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>The token for the login command will be generates from the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc whoami -t</code></pre>
</div>
</div>
<div class="paragraph">
<p>Combined together the Buildah login command (for the example repository-URL, and where XX is replaced by your user number) becomes :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah login --username userXX --password $(oc whoami -t) default-route-openshift-image-registry.apps.cluster-wfh1-8946.wfh1-8946.example.opentlc.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get a response of "Login Succeeded!"</p>
</div>
</div>
<div class="sect3">
<h4 id="login-to-quay-using-buildah"><a class="anchor" href="#login-to-quay-using-buildah"></a>Login to Quay using Buildah</h4>
<div class="paragraph">
<p>It is also necessary to login to the Quay image repository using the Buildah command so that images can be pushed to Quay. The URL for the Quay repository is the address in the browser window for Quay up to and including .com and excluding the https:// part.</p>
</div>
<div class="paragraph">
<p>The username and password are those which were generated and noted earlier on for the Quay robot user.</p>
</div>
<div class="paragraph">
<p>The Quay login command will be similar to :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah login --username master-slave-user23+user23_automation --password 6A6ODEQT39ID52S9HZ4IRCBO3EK4O5KNAGZ2HWKSOQQUMU9QSKMBBPYNO6A3ED0O quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get a response of "Login Succeeded!"</p>
</div>
<div class="paragraph">
<p><em>You are now logged into both OpenShift and Quay with buildah and you are ready to pull and push images.</em></p>
</div>
</div>
<div class="sect3">
<h4 id="examine-the-local-buildah-repository"><a class="anchor" href="#examine-the-local-buildah-repository"></a>Examine the local buildah repository</h4>
<div class="paragraph">
<p>Use the command below to view the local buildah image repository. You should see that it contains no images.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah images</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the command below to list the images and their location within the OpenShift image repository :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get is -o jsonpath='{range.items[*]}{.metadata.name}{" "}{.status.publicDockerImageRepository}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will generate a list of all image streams and the registry location to use in the pull command. To pull the image use the full docker image repository name in the command below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah pull docker://&lt;full-image-path&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>for example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah pull docker://default-route-openshift-image-registry.apps.cluster-wfh1-8946.wfh1-8946.example.opentlc.com/master-slave-user23/node-app-master</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command will show the progress of pulling image layers and will complete with a message similar to that which is shown below :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Getting image source signatures
Copying blob 455ea8ab0621 done
Copying blob 6a4fa4bc2d06 done
Copying blob bb13d92caffa done
Copying blob 2dd72bf14df1 done
Copying blob ff52b8e1303b done
Copying blob 84e620d0abe5 done
Copying config abc6f7ad19 done
Writing manifest to image destination
Storing signatures
abc6f7ad19646ed135d9b76946ccce2ae9b4c796a66472f34d853df009dbd18e</code></pre>
</div>
</div>
<div class="paragraph">
<p>View the local image repository with the command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah images</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be similar to that which is shown below:</p>
</div>
<table class="tableblock frame-none grid-none stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 10%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REPOSITORY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TAG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IMAGE ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SIZE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default-route-openshift-image-registry.apps.cluster-wfh1-8946.wfh1-8946.example.opentlc.com/master-slave-user23/node-app-master</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">latest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">abc6f7ad1964</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6 hours ago</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">547 MB</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>An image now exists in a local repository - either on your laptop or within the terminal container depending on where you ran the command.</p>
</div>
<div class="paragraph">
<p>Repeat the process to pull the image for the slave too. Notice this time that some of the layers are skipped as those layers already exist within the local repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="tagging-images-for-the-quay-repository"><a class="anchor" href="#tagging-images-for-the-quay-repository"></a>Tagging images for the Quay repository</h4>
<div class="paragraph">
<p>In order to push images to Quay they must have a repository identifier and tag attached to them. This is done using the Buildah tag command. The Buildah tag command takes the format :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah tag &lt;existing-repository-location&gt;:&lt;tag&gt; &lt;new-repository-location&gt;:&lt;tag&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual tag names used for the existing location need to match what is in the repository, while the new tag can be whatever is appropriate such as an incremental number, 'latest' or some other useful identifier. To reduce the amount of command line copy and paste operations when creating the existing repository location and tag the command below can be used :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get is -o jsonpath='{range.items[*]}{.metadata.name}{" "}{.status.publicDockerImageRepository}{":"}{.status.tags[0].tag}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new repository location is the Quay URL address, organization and repository name. The easiest way to get this is to go to the Quay web user interface, select 'Repositories' on the top menu and then select the master repository within the master-slave organization. This will show a screen similar to that which is shown below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-7.png" alt="Quay repository details">
</div>
</div>
<div class="paragraph">
<p>Under the heading "Pull this container with the following Docker command:", copy the URL after the 'docker pull' text in the text field. It will look similar to the below:</p>
</div>
<div class="paragraph">
<p>quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com/master-slave-user23/node-app-master</p>
</div>
<div class="paragraph">
<p>Create the Builah tag command from the information collected above such that it looks similar to the below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah tag default-route-openshift-image-registry.apps.cluster-wfh1-8946.wfh1-8946.example.opentlc.com/master-slave-user23/node-app-master:latest quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com/master-slave-user23/node-app-master:1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the tag used in the command for the destination tag is 1.</p>
</div>
<div class="paragraph">
<p>Execute the command and then use the command below to list the images :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah images</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repeat the similar command for the slave image.</p>
</div>
</div>
<div class="sect3">
<h4 id="push-the-images-to-quay"><a class="anchor" href="#push-the-images-to-quay"></a>Push the images to Quay</h4>
<div class="paragraph">
<p>Push the images to Quay using the commands of the format :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah push &lt;new-repository-location&gt;:&lt;tag&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>for example :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>buildah push quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com/master-slave-user23/node-app-master:1
buildah push quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com/master-slave-user23/node-app-slave:1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch to the Quay web user interface. If you are still displaying the repository information page where the image pull / push URL was copied from then refresh the browse window and then select the 'tags' view (2nd option down on the repository menu). This will show the tags view similar to that which is shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/quay-8.png" alt="Quay repository tags view">
</div>
</div>
<div class="paragraph">
<p>The tags view shows information on the image tag and the buttons on the right of each line allow the user to select different mechanisms for extracting and manipulating the image.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-the-images-in-a-qa-environment"><a class="anchor" href="#using-the-images-in-a-qa-environment"></a>Using the images in a QA environment</h3>
<div class="paragraph">
<p>Referring to the image at the top of this section the image may now be pulled to different clusters such as a QA cluster, pre-production cluster and production cluster. Specific users will have the appropriate role based permissions to pull the images into those clusters to control the necessary separation of responsibilities within an organization. For this exercise you will create a new project with the same name as the existing project but with -qa on the end of the name to simulate the deployment to QA.</p>
</div>
<div class="paragraph">
<p>The original commands used to create the images at the start of this section used the source-2-image capability and pulled the source code. The process from this point forward has no interaction with the application source code and pulls the immutable images into each successive cluster (simulated in the case of the workshop), with environment specific information being injected into the running containers using config maps. This use of immutable images is one significant advantage of containers and hence is another reason for the use of a secure image repository.</p>
</div>
<div class="sect3">
<h4 id="creating-the-openshift-project-for-qa"><a class="anchor" href="#creating-the-openshift-project-for-qa"></a>Creating the OpenShift Project for QA</h4>
<div class="paragraph">
<p>Use the commands below to create the OpenShift project using the content from Quay as the source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-project master-slave-userXX-qa

oc new-app --docker-image=&lt;master image URL &amp; tag that was pushed above&gt; --name=node-app-master
oc new-app --docker-image=&lt;master image URL &amp; tag that was pushed above&gt; --name=node-app-slave
oc expose service node-app-master --name="master-app-route"</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>where XX is your user ID</em></p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc new-app --docker-image=quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com/master-slave-user23/node-app-master:1 --name=node-app-master
oc new-app --docker-image=quay-b2b3.apps.shared-rhpds.rhpds.openshift.opentlc.com/master-slave-user23/node-app-slave:1 --name=node-app-slave
oc expose service node-app-master --name="master-app-route"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test the application get the route with the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc get route -o jsonpath='{.items[0].spec.host}{"/ip\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then issue the following curl command :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -k &lt;url from the above command&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response should be the ip address of the master node and the slave node similar to that which is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>"master ip address 10.131.0.174    ----&gt; slave ip address 10.128.2.157 v1.0"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cleaning-up"><a class="anchor" href="#cleaning-up"></a>Cleaning up</h3>
<div class="paragraph">
<p>Finally, lets clean up the project by typing</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>oc delete project master-slave-userXX
oc delete project master-slave-userXX-qa</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>where XX is your user ID</em></p>
</div>
<div class="paragraph">
<p>This will delete the projects</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0<br>
Last updated 2020-04-01 13:20:30 +0100
</div>
</div>
</body>
</html>